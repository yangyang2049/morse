import { MorseCodeData } from '../../models/MorseCode'
import { PinyinService } from '../../services/PinyinService'
import { promptAction } from '@kit.ArkUI'
import { resourceManager, i18n } from '@kit.LocalizationKit'
import { pasteboard } from '@kit.BasicServicesKit'
import { AudioService } from '../../services/AudioService'
import { flashlightService } from '../../services/FlashlightService'
import { common } from '@kit.AbilityKit'

@Component
export struct TranslatePage {
  @State isTextToMorse: boolean = true
  @State textInput: string = ''
  @State morseInput: string = ''
  private readonly boxFontSize: number = 16
  private readonly pillRadius: number = 20
  @State currentLanguage: string = 'zh-CN'
  // èµ„æºç®¡ç†å™¨
  private resourceMgr: resourceManager.ResourceManager | null = null
  // éŸ³é¢‘æœåŠ¡
  private audioService: AudioService = AudioService.getInstance()
  @State isPlaying: boolean = false
  // æ‰‹ç”µç­’æœåŠ¡
  @State flashlightInitialized: boolean = false
  @State isPlayingFlashlight: boolean = false

  async aboutToAppear(): Promise<void> {
    // åˆå§‹åŒ–èµ„æºç®¡ç†å™¨
    try {
      this.resourceMgr = getContext(this).resourceManager
    } catch (error) {
      console.error('[TranslatePage] Failed to get resource manager:', error)
    }

    // è·å–å½“å‰ç³»ç»Ÿè¯­è¨€
    this.currentLanguage = this.getCurrentLanguage()

    // System bar colors are set globally in EntryAbility
    // Preload pinyin dictionary for Chinese â†’ pinyin conversion
    const uiContext = this.getUIContext()
    const hostContext = uiContext.getHostContext()
    if (hostContext) {
      PinyinService.load(hostContext)

      // åˆå§‹åŒ–éŸ³é¢‘æœåŠ¡
      try {
        await this.audioService.init(hostContext)
      } catch (error) {
        console.error('[TranslatePage] Failed to init audio service:', error)
      }

      // æ‰‹ç”µç­’æœåŠ¡æ”¹ä¸ºå»¶è¿Ÿåˆå§‹åŒ–ï¼ˆé¦–æ¬¡ç‚¹å‡»æ—¶æ‰åˆå§‹åŒ–ï¼‰
    }
  }

  aboutToDisappear() {
    // åœæ­¢éŸ³é¢‘æ’­æ”¾
    this.audioService.stopAudio()

    // åœæ­¢æ‰‹ç”µç­’æ’­æ”¾
    if (this.isPlayingFlashlight) {
      flashlightService.stopPlaying()
      this.isPlayingFlashlight = false
    }
  }

  // è·å–å½“å‰ç³»ç»Ÿè¯­è¨€
  private getCurrentLanguage(): string {
    try {
      const currentLocale = i18n.System.getSystemLocale()
      // å°†ç³»ç»Ÿlocaleè½¬æ¢ä¸ºæˆ‘ä»¬çš„è¯­è¨€ä»£ç æ ¼å¼
      if (currentLocale.startsWith('zh')) {
        return 'zh-CN'
      } else if (currentLocale.startsWith('en')) {
        return 'en-US'
      }
      return 'zh-CN' // é»˜è®¤ä¸­æ–‡
    } catch (error) {
      console.error('[TranslatePage] Failed to get current language:', error)
      return 'zh-CN' // é»˜è®¤ä¸­æ–‡
    }
  }

  // è·å–ç³»ç»Ÿèµ„æºå­—ç¬¦ä¸²
  private async getStringResource(key: string): Promise<string> {
    try {
      if (this.resourceMgr) {
        // ä½¿ç”¨èµ„æºIDè·å–å­—ç¬¦ä¸²
        const resourceId = await this.resourceMgr.getStringByName(key)
        return resourceId
      }
      return key
    } catch (error) {
      console.error(`[TranslatePage] Failed to get string resource for key: ${key}`, error)
      return key
    }
  }


  private getOutput(): string {
    if (this.isTextToMorse) {
      return MorseCodeData.textToMorse(this.textInput, (char: string) => {
        // æ˜¾ç¤ºä¸­æ–‡å­—ç¬¦ä¸åœ¨æ‹¼éŸ³è¡¨ä¸­çš„æç¤º
        const isChinese = this.currentLanguage.startsWith('zh')
        promptAction.showToast({
          message: isChinese ? `"${char}" ä¸åœ¨æ‹¼éŸ³è¡¨ä¸­` : `"${char}" not in pinyin table`,
          duration: 2000,
          bottom: '80%'
        })
      })
    } else {
      return MorseCodeData.morseToText(this.morseInput)
    }
  }

  // æ·»åŠ ç‚¹
  private addDot() {
    this.morseInput += '.'
  }

  // æ·»åŠ åˆ’
  private addDash() {
    this.morseInput += '-'
  }

  // æ·»åŠ æ–œæ ï¼ˆå•è¯/å¥å­åˆ†éš”ç¬¦ï¼‰
  private addSlash() {
    this.morseInput += '/'
  }

  // æ·»åŠ ç©ºæ ¼
  private addSpace() {
    this.morseInput += ' '
  }

  // åˆ é™¤æœ€åä¸€ä¸ªå­—ç¬¦
  private deleteLast() {
    if (this.morseInput.length > 0) {
      this.morseInput = this.morseInput.slice(0, -1)
    }
  }

  // æ’­æ”¾æ‘©å°”æ–¯ç”µç å£°éŸ³
  private async playMorseSound() {
    if (this.isPlaying) {
      // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢æ’­æ”¾
      this.audioService.stopAudio()
      this.isPlaying = false
      return
    }

    let contentToPlay = ''

    if (this.isTextToMorse) {
      // æ–‡æœ¬è½¬æ‘©å°”æ–¯ï¼šæ’­æ”¾è½¬æ¢åçš„æ‘©å°”æ–¯ç”µç ï¼ˆä½¿ç”¨æ ‡å‡†ç‚¹ï¼‰
      contentToPlay = MorseCodeData.textToMorseForPlay(this.textInput)
    } else {
      // æ‘©å°”æ–¯è½¬æ–‡æœ¬ï¼šæ’­æ”¾è¾“å…¥çš„æ‘©å°”æ–¯ç”µç 
      contentToPlay = this.morseInput
    }

    if (contentToPlay.length === 0) {
      // æ²¡æœ‰å†…å®¹å¯æ’­æ”¾
      try {
        promptAction.showToast({
          message: this.currentLanguage.startsWith('zh') ? 'æ²¡æœ‰å†…å®¹å¯æ’­æ”¾' : 'No content to play',
          duration: 1500,
          bottom: '80%'
        })
      } catch (error) {
        console.error('[TranslatePage] Failed to show toast:', error)
      }
      return
    }

    try {
      this.isPlaying = true
      await this.audioService.playMorseSequence(contentToPlay)
    } catch (error) {
      console.error('[TranslatePage] Failed to play morse sound:', error)
      try {
        promptAction.showToast({
          message: this.currentLanguage.startsWith('zh') ? 'æ’­æ”¾å¤±è´¥' : 'Playback failed',
          duration: 1500,
          bottom: '80%'
        })
      } catch (toastError) {
        console.error('[TranslatePage] Failed to show error toast:', toastError)
      }
    } finally {
      this.isPlaying = false
    }
  }

  // æ’­æ”¾æ‘©å°”æ–¯ç æ‰‹ç”µç­’
  private async playMorseFlashlight(): Promise<void> {
    // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåˆ™åœæ­¢
    if (this.isPlayingFlashlight) {
      flashlightService.stopPlaying()
      this.isPlayingFlashlight = false
      return
    }

    // å¦‚æœæœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ï¼ˆè¿™é‡Œä¼šè¯·æ±‚æƒé™ï¼‰
    if (!this.flashlightInitialized) {
      try {
        console.info('[TranslatePage] Initializing flashlight service on first use...')
        const uiContext = this.getUIContext()
        const hostContext = uiContext.getHostContext()

        if (!hostContext) {
          throw new Error('Failed to get host context')
        }

        await flashlightService.init(hostContext as common.BaseContext)
        this.flashlightInitialized = true
        console.info('[TranslatePage] Flashlight service initialized successfully')
      } catch (error) {
        console.error('[TranslatePage] Failed to init flashlight service:', error)
        this.flashlightInitialized = false

        // æ˜¾ç¤ºæƒé™æç¤º
        const errorMsg = String(error)
        if (errorMsg.includes('permission')) {
          try {
            promptAction.showToast({
              message: this.currentLanguage.startsWith('zh') ?
                'éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨æ‰‹ç”µç­’åŠŸèƒ½' :
                'Camera permission required for flashlight',
              duration: 3000,
              bottom: '80%'
            })
          } catch (toastError) {
            console.error('[TranslatePage] Failed to show permission toast:', toastError)
          }
        } else {
          try {
            promptAction.showToast({
              message: this.currentLanguage.startsWith('zh') ?
                'æ‰‹ç”µç­’åˆå§‹åŒ–å¤±è´¥' :
                'Failed to initialize flashlight',
              duration: 2000,
              bottom: '80%'
            })
          } catch (toastError) {
            console.error('[TranslatePage] Failed to show toast:', toastError)
          }
        }
        return
      }
    }

    let contentToPlay = ''
    if (this.isTextToMorse) {
      contentToPlay = MorseCodeData.textToMorseForPlay(this.textInput)
    } else {
      contentToPlay = this.morseInput
    }

    if (contentToPlay.length === 0) {
      try {
        promptAction.showToast({
          message: this.currentLanguage.startsWith('zh') ? 'æ²¡æœ‰å†…å®¹å¯æ’­æ”¾' : 'No content to play',
          duration: 1500,
          bottom: '80%'
        })
      } catch (error) {
        console.error('[TranslatePage] Failed to show toast:', error)
      }
      return
    }

    try {
      this.isPlayingFlashlight = true
      await flashlightService.playMorseCode(contentToPlay)
    } catch (error) {
      console.error('[TranslatePage] Failed to play morse flashlight:', error)
      try {
        promptAction.showToast({
          message: this.currentLanguage.startsWith('zh') ? 'æ‰‹ç”µç­’æ’­æ”¾å¤±è´¥' : 'Flashlight playback failed',
          duration: 2000,
          bottom: '80%'
        })
      } catch (toastError) {
        console.error('[TranslatePage] Failed to show toast:', toastError)
      }
    } finally {
      this.isPlayingFlashlight = false
    }
  }

  // æ’­æ”¾SOSä¿¡å·ï¼ˆä¿ç•™ä½†æœªåœ¨UIä¸­ä½¿ç”¨ï¼‰
  private async playSOS(): Promise<void> {
    if (this.isPlayingFlashlight) {
      flashlightService.stopPlaying()
      this.isPlayingFlashlight = false
      return
    }

    // å¦‚æœæœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–ï¼ˆè¿™é‡Œä¼šè¯·æ±‚æƒé™ï¼‰
    if (!this.flashlightInitialized) {
      try {
        console.info('[TranslatePage] Initializing flashlight service for SOS...')
        const uiContext = this.getUIContext()
        const hostContext = uiContext.getHostContext()

        if (!hostContext) {
          throw new Error('Failed to get host context')
        }

        await flashlightService.init(hostContext as common.BaseContext)
        this.flashlightInitialized = true
        console.info('[TranslatePage] Flashlight service initialized successfully')
      } catch (error) {
        console.error('[TranslatePage] Failed to init flashlight service:', error)
        this.flashlightInitialized = false

        const errorMsg = String(error)
        if (errorMsg.includes('permission')) {
          try {
            promptAction.showToast({
              message: this.currentLanguage.startsWith('zh') ?
                'éœ€è¦ç›¸æœºæƒé™æ‰èƒ½ä½¿ç”¨æ‰‹ç”µç­’åŠŸèƒ½' :
                'Camera permission required for flashlight',
              duration: 3000,
              bottom: '80%'
            })
          } catch (toastError) {
            console.error('[TranslatePage] Failed to show toast:', toastError)
          }
        }
        return
      }
    }

    try {
      this.isPlayingFlashlight = true
      await flashlightService.playSOS()
      try {
        promptAction.showToast({
          message: 'SOS',
          duration: 1500,
          bottom: '80%'
        })
      } catch (toastError) {
        console.error('[TranslatePage] Failed to show toast:', toastError)
      }
    } catch (error) {
      console.error('[TranslatePage] Failed to play SOS:', error)
    } finally {
      this.isPlayingFlashlight = false
    }
  }

  // è·å–è¾“å…¥/è¾“å‡ºæ¡†çš„é«˜åº¦
  private getBoxHeight(): number | string {
    return '25%'
  }

  @Builder
  private TitleBar() {
    Row() {
      Text($r('app.string.translate'))
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
    }
    .height(56)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#000000')
  }

  @Builder
  private ModeToggle() {
    Row() {
      // æ–‡æœ¬ â†’ ç”µç 
      Button($r('app.string.text_to_morse'))
        .onClick(() => { this.isTextToMorse = true })
        .backgroundColor(this.isTextToMorse ? '#FFD700' : '#1A1A1A')
        .fontColor(this.isTextToMorse ? '#000000' : '#B0B0B0')
        .borderRadius(16)
        .padding({ left: 14, right: 14 })
        .margin({ right: 8 })
        .border({ width: 1, color: '#333333' })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // ç”µç  â†’ æ–‡æœ¬
      Button($r('app.string.morse_to_text'))
        .onClick(() => { this.isTextToMorse = false })
        .backgroundColor(!this.isTextToMorse ? '#FFD700' : '#1A1A1A')
        .fontColor(!this.isTextToMorse ? '#000000' : '#B0B0B0')
        .borderRadius(16)
        .padding({ left: 14, right: 14 })
        .border({ width: 1, color: '#333333' })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)
    }
    .justifyContent(FlexAlign.Center)
      .padding(12)
  }

  @Builder
  private InputArea() {
    RelativeContainer() {
      // è¾“å…¥æ¡†
      if (this.isTextToMorse) {
        TextArea({ text: this.textInput, placeholder: $r('app.string.input_text_placeholder') })
          .layoutWeight(1)
          .fontSize(this.boxFontSize)
          .fontColor(Color.White)
          .placeholderColor(Color.White)
          .caretColor(Color.White)
          .margin(12)
          .maxLines(6)
          .onChange((v: string) => { this.textInput = v })
          .id('text_input_area')
      } else {
        TextArea({ text: this.morseInput, placeholder: $r('app.string.input_morse_placeholder') })
          .layoutWeight(1)
          .fontSize(this.boxFontSize)
          .fontColor(Color.White)
          .placeholderColor(Color.White)
          .caretColor(Color.White)
          .margin(12)
          .maxLines(6)
          .onChange((v: string) => { this.morseInput = v })
          .id('morse_input_area')
      }

      // æ¸…é™¤æŒ‰é’®ï¼ˆå³ä¸‹è§’æµ®åŠ¨ï¼‰
      if ((this.isTextToMorse && this.textInput.length > 0) || (!this.isTextToMorse && this.morseInput.length > 0)) {
        Button() {
          Image($rawfile('ic_clear.svg'))
            .width(20)
            .height(20)
        }
        .width(36)
          .height(36)
          .backgroundColor(Color.Transparent)
          .borderRadius(18)
          .alignRules({
            bottom: { anchor: this.isTextToMorse ? 'text_input_area' : 'morse_input_area', align: VerticalAlign.Bottom },
            right: { anchor: this.isTextToMorse ? 'text_input_area' : 'morse_input_area', align: HorizontalAlign.End }
          })
          .margin({ right: -4, bottom: 8 })
          .onClick(() => {
            if (this.isTextToMorse) {
              this.textInput = ''
            } else {
              this.morseInput = ''
            }
            // æ¸…é™¤è¾“å…¥åï¼Œè¾“å‡ºä¹Ÿä¼šè‡ªåŠ¨æ›´æ–°ä¸ºç©º
          })
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
          .zIndex(1)
      }
    }
    .height(this.getBoxHeight())
      .backgroundColor('#1A1A1A')
      .borderRadius(12)
      .margin({ left: 12, right: 12 })
      .border({ width: 1, color: '#333333' })
  }

  @Builder
  private OutputArea() {
    RelativeContainer() {
      // è¾“å‡ºæ¡†
      TextArea({
        text: this.getOutput().length > 0 ? this.getOutput() :
          (this.isTextToMorse ? $r('app.string.output_text_placeholder') : $r('app.string.output_morse_placeholder'))
      })
        .layoutWeight(1)
        .fontSize(this.boxFontSize)
        .margin(12)
        .backgroundColor(Color.Transparent)
        .fontColor('#FFFFFF')
        .enabled(false)
        .maxLines(6)
        .id('output_area')

      // æ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆå³ä¸‹è§’æµ®åŠ¨ï¼Œä»…å½“æœ‰è¾“å‡ºæ—¶æ˜¾ç¤ºï¼‰
      if (this.getOutput().length > 0) {
        Column() {
          // æ’­æ”¾æŒ‰é’®ï¼ˆä»…åœ¨æ–‡æœ¬è½¬æ‘©å°”æ–¯æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
          if (this.isTextToMorse) {
            Button() {
              Image($rawfile(this.isPlaying ? 'ic_pause.svg' : 'ic_play.svg'))
                .width(20)
                .height(20)
            }
            .width(36)
              .height(36)
              .backgroundColor(Color.Transparent)
              .borderRadius(18)
              .onClick(() => {
                this.playMorseSound()
              })
              .hoverEffect(HoverEffect.Scale)
              .focusable(true)

            // æ‰‹ç”µç­’æŒ‰é’®
            Button() {
              Text(this.isPlayingFlashlight ? 'â¸' : 'ğŸ”¦')
                .fontSize(20)
            }
            .width(36)
              .height(36)
              .backgroundColor(Color.Transparent)
              .borderRadius(18)
              .margin({ top: 4 })
              .onClick(() => {
                this.playMorseFlashlight()
              })
              .hoverEffect(HoverEffect.Scale)
              .focusable(true)
          }

          // å¤åˆ¶æŒ‰é’®
          Button() {
            Image($rawfile('ic_copy.svg'))
              .width(20)
              .height(20)
          }
          .width(36)
            .height(36)
            .backgroundColor(Color.Transparent)
            .borderRadius(18)
            .margin({ top: 4 })
            .onClick(() => {
              // å¤åˆ¶è¾“å‡ºå†…å®¹åˆ°å‰ªè´´æ¿
              const outputText = this.getOutput()
              const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, outputText)
              const systemPasteboard = pasteboard.getSystemPasteboard()
              systemPasteboard.setData(pasteData)

              promptAction.showToast({
                message: $r('app.string.copied'),
                duration: 1500,
                bottom: '80%'
              })
            })
            .hoverEffect(HoverEffect.Scale)
            .focusable(true)
        }
        .alignRules({
          top: { anchor: 'output_area', align: VerticalAlign.Top },
          right: { anchor: 'output_area', align: HorizontalAlign.End }
        })
          .margin({ right: -4, top: 8 })
          .zIndex(1)
      }
    }
    .height(this.getBoxHeight())
      .backgroundColor('#1A1A1A')
      .borderRadius(12)
      .margin({ left: 12, right: 12, bottom: 12 })
      .border({ width: 1, color: '#333333' })
  }

  @Builder
  private BottomKeys() {
    Column() {
      // å°æŒ‰é’®è¡Œ
      Row() {
        // æ–œæ æŒ‰é’® (ç¬¬ä¸€ä¸ª) - å•è¯/å¥å­åˆ†éš”ç¬¦
        Button() {
          Text('/')
            .fontSize(18)
            .fontColor('#FFD700')
            .fontWeight(FontWeight.Bold)
        }
        .height(40)
          .backgroundColor('#1A1A1A')
          .borderRadius(0)
          .border({ width: 1, color: '#333333' })
          .onClick(() => this.addSlash())
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
          .layoutWeight(1)

        Blank().width(8)

        // ç©ºæ ¼æŒ‰é’® (ç¬¬äºŒä¸ª)
        Button() {
          Text('âµ')
            .fontSize(16)
            .fontColor('#FFD700')
            .fontWeight(FontWeight.Bold)
        }
        .height(40)
          .backgroundColor('#1A1A1A')
          .borderRadius(0)
          .border({ width: 1, color: '#333333' })
          .onClick(() => this.addSpace())
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
          .layoutWeight(1)

        Blank().width(8)

        // åˆ é™¤æŒ‰é’® (ç¬¬ä¸‰ä¸ª)
        Button() {
          Text('âŒ«')
            .fontSize(16)
            .fontColor('#FFD700')
            .fontWeight(FontWeight.Bold)
        }
        .height(40)
          .backgroundColor('#1A1A1A')
          .borderRadius(0)
          .border({ width: 1, color: '#333333' })
          .onClick(() => this.deleteLast())
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
          .layoutWeight(1)
      }
      .padding({ left: 20, right: 20 })

      Blank().height(12)

      // ä¸»è¦çš„ç‚¹å’Œåˆ’æŒ‰é’®
      Row() {
        Button() {
          Circle({ width: 20, height: 20 })
            .fill('#FFD700')
        }
        .height(80)
          .backgroundColor('#1A1A1A')
          .borderRadius(this.pillRadius)
          .border({ width: 1, color: '#333333' })
          .onClick(async () => {
            this.addDot()
            // æ’­æ”¾ç‚¹éŸ³
            if (this.morseInput.length > 0) {
              try {
                await this.audioService.playDit()
              } catch (error) {
                console.error('[TranslatePage] Failed to play dit:', error)
              }
            }
          })
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
          .layoutWeight(1)

        Blank().width(20)

        Button() {
          Rect({ width: 40, height: 12 })
            .fill('#FFD700')
        }
        .height(80)
          .backgroundColor('#1A1A1A')
          .borderRadius(this.pillRadius)
          .border({ width: 1, color: '#333333' })
          .onClick(async () => {
            this.addDash()
            // æ’­æ”¾åˆ’éŸ³
            if (this.morseInput.length > 0) {
              try {
                await this.audioService.playDah()
              } catch (error) {
                console.error('[TranslatePage] Failed to play dah:', error)
              }
            }
          })
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
          .layoutWeight(1)
      }
      .padding({ left: 20, right: 20, bottom: 60 })
    }
  }

  build() {
    Column() {
      this.TitleBar()

      // å†…å®¹åŒºåŸŸ - å“åº”å¼å®½åº¦ï¼Œæœ€å¤§480vp
      Column() {
        this.ModeToggle()
        this.InputArea()
        Blank().height(12)
        this.OutputArea()

        // åœ¨ç”µç â†’æ–‡æœ¬æ¨¡å¼ä¸‹æ˜¾ç¤ºåº•éƒ¨æŒ‰é’®
        if (!this.isTextToMorse) {
          Blank().layoutWeight(1)
          this.BottomKeys()
        }
      }
      .width('100%')
        .constraintSize({ maxWidth: 480 })
        .padding({ left: 20, right: 20 })
        .layoutWeight(1)
        .justifyContent(FlexAlign.Start)
        .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
      .height('100%')
      .backgroundColor('#000000')
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
