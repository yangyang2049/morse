import { promptAction } from '@kit.ArkUI'
import { common, Want } from '@kit.AbilityKit'
import pasteboard from '@ohos.pasteboard'

@Component
export struct MePage {
  @State appVersion: string = '1.0.0'
  @State appName: string = 'æ‘©æ–¯å¯†ç '

  aboutToAppear() {
    this.loadAppInfo()
  }

  private loadAppInfo() {
    this.appVersion = '1.0.0'
    this.appName = 'æ‘©æ–¯å¯†ç '
  }

  // ä½¿ç”¨è¯´æ˜
  private showInstructions() {
    promptAction.showDialog({
      title: 'ä½¿ç”¨è¯´æ˜',
      message: '1. å­¦ä¹ ï¼šä»åŸºç¡€è¯¾ç¨‹å¼€å§‹ï¼Œé€æ­¥æŒæ¡æ‘©å°”æ–¯ç”µç \n2. ç»ƒä¹ ï¼šé€šè¿‡ä¸åŒéš¾åº¦çš„ç»ƒä¹ å·©å›ºå­¦ä¹ æˆæœ\n3. ç¿»è¯‘ï¼šå°†æ–‡å­—è½¬æ¢ä¸ºæ‘©å°”æ–¯ç”µç æˆ–åå‘è½¬æ¢\n4. ç è¡¨ï¼šæŸ¥çœ‹å®Œæ•´çš„æ‘©å°”æ–¯ç”µç å¯¹ç…§è¡¨\n\nç‚¹å‡»æ’­æ”¾æŒ‰é’®å¯ä»¥å¬åˆ°æ‘©å°”æ–¯ç”µç çš„å£°éŸ³',
      buttons: [
        {
          text: 'çŸ¥é“äº†',
          color: '#FFD700'
        }
      ],
      alignment: DialogAlignment.Center
    }).then((result) => {
      console.log('ç”¨æˆ·ç¡®è®¤äº†ä½¿ç”¨è¯´æ˜')
    })
  }

  // è¯„åˆ†å’Œåé¦ˆ
  private showRating() {
    this.openAppGallery()
  }

  // åˆ†äº«åº”ç”¨
  private shareApp(): void {
    try {
      const shareText = 'æ¨èä¸€æ¬¾å­¦ä¹ æ‘©å°”æ–¯å¯†ç çš„åº”ç”¨ï¼š\nã€Šæ‘©æ–¯å¯†ç ã€‹ğŸ“¡\n\nâ€¢ ä»é›¶å­¦ä¹ æ‘©å°”æ–¯ç”µç \nâ€¢ è·Ÿè¯»ç»ƒä¹ ä¸å¬åŠ›è®­ç»ƒ\nâ€¢ æ–‡æœ¬ä¸æ‘©æ–¯äº’ç›¸ç¿»è¯‘\n\nç«‹å³ä¸‹è½½ï¼š\nhttps://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'

      const sysPB = pasteboard.getSystemPasteboard()
      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, shareText)
      sysPB.setPasteData(pasteData)

      promptAction.showToast({
        message: 'åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
        duration: 2000
      })
    } catch (error) {
      console.error('å¤åˆ¶åˆ°å‰ªè´´æ¿å¤±è´¥:', error)
      promptAction.showToast({
        message: 'å¤åˆ¶å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
        duration: 2000
      })
    }
  }

  // æ‰“å¼€åº”ç”¨å¸‚åœºè¿›è¡Œè¯„åˆ†å’Œåé¦ˆ
  private openAppGallery(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.morsecode'
        }
      }

      context.startAbility(want).then(() => {
        promptAction.showToast({
          message: 'æ­£åœ¨æ‰“å¼€åº”ç”¨å¸‚åœºâ€¦',
          duration: 1500
        })
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openAppGalleryByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openAppGalleryByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºé¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openAppGalleryByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'
      }

      context.startAbility(want).then(() => {
        promptAction.showToast({
          message: 'å·²é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœº',
          duration: 2000
        })
      }).catch((error: Error) => {
        console.error('æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        promptAction.showToast({
          message: 'æ— æ³•æ‰“å¼€åº”ç”¨å¸‚åœºï¼Œè¯·ç¨åé‡è¯•',
          duration: 3000
        })
      })
    } catch (error) {
      console.error('å¤‡é€‰æ–¹æ¡ˆå¼‚å¸¸:', error)
      promptAction.showToast({
        message: 'æ— æ³•æ‰“å¼€åº”ç”¨å¸‚åœºï¼Œè¯·ç¨åé‡è¯•',
        duration: 3000
      })
    }
  }



  @Builder SettingsItem(title: string, onClick: () => void) {
    Row() {
      Column() {
        Text(title)
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Start)

      Image($rawfile('ic_arrow_right.svg'))
        .width(16)
        .height(16)
        .fillColor('#666666')
    }
    .width('100%')
    .height(52)
    .padding({ left: 16, right: 16 })
    .onClick(onClick)
  }

  build() {
    Column() {
      // å¤´éƒ¨ - åº”ç”¨ä¿¡æ¯ï¼ˆé»‘è‰²èƒŒæ™¯ï¼Œå›¾æ ‡ç½®é¡¶ï¼‰
      Column() {
        Image($r('app.media.startIcon'))
          .width(80)
          .height(80)
          .borderRadius(20)
          .margin({ bottom: 16 })
          .shadow({
            radius: 8,
            color: 'rgba(255, 255, 255, 0.3)',
            offsetX: 0,
            offsetY: 2
          })

        Text(this.appName)
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
          .margin({ bottom: 4 })

        Text(`ç‰ˆæœ¬ ${this.appVersion}`)
          .fontSize(14)
          .fontColor('#B0B0B0')
        }
        .width('100%')
        .padding({ top: 60, bottom: 40 })
        .alignItems(HorizontalAlign.Center)

        // è®¾ç½®é¡¹ï¼ˆé»‘è‰²èƒŒæ™¯å¡ç‰‡ + åˆ†å‰²çº¿ï¼Œæ— å›¾æ ‡ï¼‰
        Column() {
        // ç›’å­å®¹å™¨
        Column() {
          this.SettingsItem('ä½¿ç”¨è¯´æ˜', () => {
            this.showInstructions()
          })
          Divider().strokeWidth(1).color('#222222')

          this.SettingsItem('è¯„åˆ†å’Œåé¦ˆ', () => {
            this.openAppGallery()
          })
          Divider().strokeWidth(1).color('#222222')

          this.SettingsItem('åˆ†äº«åº”ç”¨', () => {
            this.shareApp()
          })
        }
        .width('100%')
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .padding({ top: 4, bottom: 4 })
        .constraintSize({ maxWidth: 400 })
      }
      .width('100%')
      .padding({ left: 20, right: 20 })
      .layoutWeight(1)
      .alignItems(HorizontalAlign.Center)

      // åº•éƒ¨
      Column() {
        Text('è®©å­¦ä¹ æ‘©æ–¯å¯†ç ç®€å•åˆæœ‰è¶£')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#CCCCCC')
          .margin({ bottom: 16 })

        Text('Â© 2025 é‡åº†è±†èŠ±ç§‘æŠ€æœ‰é™å…¬å¸')
          .fontSize(12)
          .fontColor('#999999')
      }
      .width('100%')
      .padding({ bottom: 20 })
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#000000')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
