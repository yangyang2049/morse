import { promptAction } from '@kit.ArkUI'
import { common, Want } from '@kit.AbilityKit'
import pasteboard from '@ohos.pasteboard'
import { resourceManager, i18n } from '@kit.LocalizationKit'
import { BusinessError } from '@kit.BasicServicesKit'
import preferences from '@ohos.data.preferences'
import { systemShare } from '@kit.ShareKit'
import { uniformTypeDescriptor } from '@kit.ArkData'
import { vibratorService } from '../../services/VibratorService'
// æ‰‹ç”µç­’åŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢
// import { flashlightService } from '../../services/FlashlightService'

// è¯­è¨€é€‰é¡¹æ¥å£
interface LanguageOption {
  code: string
  nativeName: string
}

// æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
const SUPPORTED_LANGUAGES: LanguageOption[] = [
  { code: 'zh-CN', nativeName: 'ç®€ä½“ä¸­æ–‡' },
  { code: 'zh-HK', nativeName: 'ç¹é«”ä¸­æ–‡' },
  { code: 'en-US', nativeName: 'English' }
]

@Component
export struct MePage {
  @State appVersion: string = '1.3.1'
  @StorageLink('currentLanguage') currentLanguage: string = this.getInitialLanguage()
  @State useSingleButton: boolean = false // æ˜¯å¦ä½¿ç”¨å•æŒ‰é’®æ¨¡å¼
  @State showButtonModeDialog: boolean = false // æ˜¯å¦æ˜¾ç¤ºæŒ‰é’®æ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†
  @State vibrationEnabled: boolean = true // æŒ¯åŠ¨åé¦ˆå¼€å…³
  // æ‰‹ç”µç­’ç›¸å…³çŠ¶æ€å·²ç§»é™¤ï¼ˆåŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢ï¼‰
  // @State isFlashlightOn: boolean = false
  // @State flashlightInitialized: boolean = false
  // @State isPlayingSOS: boolean = false
  // èµ„æºç®¡ç†å™¨
  private resourceMgr: resourceManager.ResourceManager | null = null
  private preferencesStore: preferences.Preferences | null = null
  private privacyLink = 'https://agreement-drcn.hispace.dbankcloud.cn/index.html?lang=zh&agreementId=1776276266387804160'

  async aboutToAppear() {
    // åˆå§‹åŒ–èµ„æºç®¡ç†å™¨
    try {
      this.resourceMgr = getContext(this).resourceManager
    } catch (error) {
      console.error('[MePage] Failed to get resource manager:', error)
    }

    // åˆå§‹åŒ–åå¥½è®¾ç½®å­˜å‚¨
    await this.initPreferences()
    // åŠ è½½æŒ‰é’®æ¨¡å¼åå¥½è®¾ç½®
    await this.loadButtonModePreference()
    // åŠ è½½æŒ¯åŠ¨åå¥½è®¾ç½®
    await this.loadVibrationPreference()

    // æ‰‹ç”µç­’æœåŠ¡åˆå§‹åŒ–å·²ç§»é™¤ï¼ˆåŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢ï¼‰

    this.loadAppInfo()
  }

  // è·å–åˆå§‹è¯­è¨€
  private getInitialLanguage(): string {
    try {
      const currentLocale = i18n.System.getSystemLocale()
      console.log(`[MePage] System locale: ${currentLocale}`)
      // å°†ç³»ç»Ÿlocaleè½¬æ¢ä¸ºæˆ‘ä»¬çš„è¯­è¨€ä»£ç æ ¼å¼
      if (currentLocale.startsWith('zh')) {
        // åˆ¤æ–­æ˜¯ç¹ä½“è¿˜æ˜¯ç®€ä½“
        if (currentLocale.includes('Hant') || currentLocale.includes('HK') || currentLocale.includes('TW') || currentLocale.includes('MO')) {
          return 'zh-HK' // ç¹ä½“ä¸­æ–‡
        }
        return 'zh-CN' // ç®€ä½“ä¸­æ–‡
      } else if (currentLocale.startsWith('en')) {
        return 'en-US'
      }
      return 'zh-CN' // é»˜è®¤ç®€ä½“ä¸­æ–‡
    } catch (error) {
      console.error('[MePage] Failed to get initial language:', error)
      return 'zh-CN' // é»˜è®¤ç®€ä½“ä¸­æ–‡
    }
  }

  aboutToDisappear() {
    // æ‰‹ç”µç­’ç›¸å…³æ¸…ç†å·²ç§»é™¤ï¼ˆåŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢ï¼‰
  }

  // è·å–ç³»ç»Ÿèµ„æºå­—ç¬¦ä¸²
  private async getStringResource(key: string): Promise<string> {
    try {
      if (this.resourceMgr) {
        // ä½¿ç”¨èµ„æºIDè·å–å­—ç¬¦ä¸²
        const resourceId = await this.resourceMgr.getStringByName(key)
        return resourceId
      }
      return key
    } catch (error) {
      console.error(`[MePage] Failed to get string resource ${key}:`, error)
      // å¦‚æœç³»ç»Ÿèµ„æºè·å–å¤±è´¥ï¼Œè¿”å›keyä½œä¸ºfallback
      return key
    }
  }

  // è®¾ç½®ç³»ç»Ÿè¯­è¨€ï¼ˆä½¿ç”¨å®˜æ–¹APIï¼‰
  private async setSystemLanguage(languageCode: string): Promise<void> {
    try {
      console.log(`[MePage] Attempting to set app preferred language to: ${languageCode}`)

      // ä½¿ç”¨HarmonyOSå®˜æ–¹APIè®¾ç½®åº”ç”¨åå¥½è¯­è¨€
      // å°†è¯­è¨€ä»£ç è½¬æ¢ä¸ºæ­£ç¡®çš„æ ¼å¼
      let preferredLanguage = languageCode
      if (languageCode === 'zh-CN') {
        preferredLanguage = 'zh-Hans-CN' // ç®€ä½“ä¸­æ–‡
      } else if (languageCode === 'zh-HK') {
        preferredLanguage = 'zh-Hant-HK' // ç¹ä½“ä¸­æ–‡ï¼ˆé¦™æ¸¯ï¼‰
      } else if (languageCode === 'en-US') {
        preferredLanguage = 'en-Latn-US' // ç¾å¼è‹±è¯­
      }

      // è®¾ç½®åº”ç”¨åå¥½è¯­è¨€
      i18n.System.setAppPreferredLanguage(preferredLanguage)
      console.log(`[MePage] App preferred language set to: ${preferredLanguage}`)

      // æ›´æ–°å½“å‰è¯­è¨€çŠ¶æ€
      this.currentLanguage = languageCode

      // åŒæ­¥åˆ°AppStorageï¼Œä¾›å…¶ä»–é¡µé¢ä½¿ç”¨
      AppStorage.setOrCreate('currentLanguage', languageCode)

      // è§¦å‘è¯­è¨€åˆ·æ–°äº‹ä»¶
      const currentTrigger = AppStorage.get<number>('languageRefreshTrigger') || 0
      AppStorage.setOrCreate('languageRefreshTrigger', currentTrigger + 1)
      console.log(`[MePage] Language refresh trigger incremented to: ${currentTrigger + 1}`)

    } catch (error) {
      const err = error as BusinessError
      console.error(`[MePage] Failed to set app preferred language, error code: ${err.code}, message: ${err.message}`)
      // å³ä½¿ç³»ç»Ÿè¯­è¨€è®¾ç½®å¤±è´¥ï¼Œä¹Ÿä¸æŠ›å‡ºé”™è¯¯ï¼Œè®©åº”ç”¨ç»§ç»­ä½¿ç”¨è‡ªå®šä¹‰i18n
    }
  }

  // è·å–å½“å‰è¯­è¨€
  private getCurrentLanguage(): string {
    try {
      const currentLocale = i18n.System.getSystemLocale()
      // å°†ç³»ç»Ÿlocaleè½¬æ¢ä¸ºæˆ‘ä»¬çš„è¯­è¨€ä»£ç æ ¼å¼
      if (currentLocale.startsWith('zh')) {
        // åˆ¤æ–­æ˜¯ç¹ä½“è¿˜æ˜¯ç®€ä½“
        if (currentLocale.includes('Hant') || currentLocale.includes('HK') || currentLocale.includes('TW') || currentLocale.includes('MO')) {
          return 'zh-HK' // ç¹ä½“ä¸­æ–‡
        }
        return 'zh-CN' // ç®€ä½“ä¸­æ–‡
      } else if (currentLocale.startsWith('en')) {
        return 'en-US'
      }
      return 'zh-CN' // é»˜è®¤ç®€ä½“ä¸­æ–‡
    } catch (error) {
      console.error('[MePage] Failed to get current language:', error)
      return 'zh-CN' // é»˜è®¤ç®€ä½“ä¸­æ–‡
    }
  }

  private loadAppInfo() {
    this.appVersion = '1.3.1'
  }

  // åˆå§‹åŒ–åå¥½è®¾ç½®å­˜å‚¨
  private async initPreferences(): Promise<void> {
    try {
      const context = getContext(this)
      this.preferencesStore = await preferences.getPreferences(context, 'practice_preferences')
      console.log('[MePage] Preferences store initialized')
    } catch (error) {
      console.error('[MePage] Failed to initialize preferences:', error)
    }
  }

  // åŠ è½½æŒ‰é’®æ¨¡å¼åå¥½è®¾ç½®
  private async loadButtonModePreference(): Promise<void> {
    try {
      if (this.preferencesStore) {
        this.useSingleButton = await this.preferencesStore.get('use_single_button', false) as boolean
        console.log(`[MePage] Loaded button mode preference: ${this.useSingleButton}`)
      }
    } catch (error) {
      console.error('[MePage] Failed to load button mode preference:', error)
    }
  }

  // ä¿å­˜æŒ‰é’®æ¨¡å¼åå¥½è®¾ç½®
  private async saveButtonModePreference(useSingle: boolean): Promise<void> {
    try {
      if (this.preferencesStore) {
        await this.preferencesStore.put('use_single_button', useSingle)
        await this.preferencesStore.put('has_set_button_mode', true)
        await this.preferencesStore.flush()
        this.useSingleButton = useSingle
        console.log(`[MePage] Saved button mode preference: ${useSingle}`)
      }
    } catch (error) {
      console.error('[MePage] Failed to save button mode preference:', error)
    }
  }

  // åŠ è½½æŒ¯åŠ¨åå¥½è®¾ç½®
  private async loadVibrationPreference(): Promise<void> {
    try {
      if (this.preferencesStore) {
        this.vibrationEnabled = await this.preferencesStore.get('vibration_enabled', true) as boolean
        vibratorService.setEnabled(this.vibrationEnabled)
        console.log(`[MePage] Loaded vibration preference: ${this.vibrationEnabled}`)
      }
    } catch (error) {
      console.error('[MePage] Failed to load vibration preference:', error)
    }
  }

  // ä¿å­˜æŒ¯åŠ¨åå¥½è®¾ç½®
  private async saveVibrationPreference(enabled: boolean): Promise<void> {
    try {
      if (this.preferencesStore) {
        await this.preferencesStore.put('vibration_enabled', enabled)
        await this.preferencesStore.flush()
        this.vibrationEnabled = enabled
        vibratorService.setEnabled(enabled)
        console.log(`[MePage] Saved vibration preference: ${enabled}`)
      }
    } catch (error) {
      console.error('[MePage] Failed to save vibration preference:', error)
    }
  }

  // è·å–å½“å‰è¯­è¨€çš„æ˜¾ç¤ºåç§°
  private getCurrentLanguageDisplayName(): string {
    const language = SUPPORTED_LANGUAGES.find(lang => lang.code === this.currentLanguage)
    return language ? language.nativeName : 'ç®€ä½“ä¸­æ–‡'
  }

  // æ‰‹ç”µç­’ç›¸å…³æ–¹æ³•å·²ç§»é™¤ï¼ˆåŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢ï¼‰
  // private async initFlashlightService(): Promise<void> { ... }
  // private async toggleFlashlight(): Promise<void> { ... }
  // private async playSOS(): Promise<void> { ... }

  // åˆ·æ–°è¯­è¨€çŠ¶æ€ - ä»AppStorageè·å–æœ€æ–°çŠ¶æ€

  // åˆ†äº«åº”ç”¨ - ä½¿ç”¨ HarmonyOS æ ‡å‡†åˆ†äº«æ¡†æ¶
  private async shareApp(): Promise<void> {
    try {
      // è·å–åˆ†äº«æ–‡æœ¬
      const isZh = this.currentLanguage.startsWith('zh')
      const shareText = isZh ? (
        'æ¨èä¸€ä¸ªè¶…æ£’çš„æ‘©å°”æ–¯ç”µç å­¦ä¹ åº”ç”¨ï¼ğŸ“Ÿâœ¨\nã€Šæ‘©æ–¯ç”µç é€šã€‹\n\nğŸ“± æ‘©æ–¯ç”µç é€š\nğŸ“ ä»é›¶å¼€å§‹å­¦ä¹ æ‘©å°”æ–¯ç”µç \nğŸ® è¶£å‘³ç»ƒä¹ ï¼Œè¾¹ç©è¾¹å­¦\nğŸ”¦ æ‰‹ç”µç­’é—ªçƒæ˜¾ç¤ºæ‘©å°”æ–¯ç \nğŸŒ™ æ”¯æŒæ·±è‰²æ¨¡å¼ï¼ŒæŠ¤çœ¼èˆ’é€‚\nğŸŒ æ”¯æŒç®€ç¹è‹±å¤šè¯­è¨€\n\nç«‹å³ä¸‹è½½ä½“éªŒï¼š\nhttps://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'
      ) : (
        'Highly recommend this great Morse code learning app! ğŸ“Ÿâœ¨\nMorse Code Trainer\n\nğŸ“± Learn Morse Code from scratch\nğŸ“ Step-by-step lessons for beginners\nğŸ® Fun practice modes\nğŸ”¦ Flashlight Morse code display\nğŸŒ™ Light and Dark themes\nğŸŒ Multi-language support\n\nTry it now:\nhttps://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'
      )

      // è·å–åˆ†äº«æ ‡é¢˜
      const shareTitle = isZh ? 'æ¨èæ‘©æ–¯ç”µç é€š' : 'Recommend Morse Code Trainer'

      // åˆ›å»ºåˆ†äº«æ•°æ®
      const shareData: systemShare.SharedData = new systemShare.SharedData({
        utd: uniformTypeDescriptor.UniformDataType.TEXT,
        content: shareText,
        title: shareTitle,
        description: isZh ? 'æ¨èæ‘©å°”æ–¯ç”µç å­¦ä¹ åº”ç”¨' : 'Recommend Morse Code Learning App'
      })

      // åˆ›å»ºåˆ†äº«æ§åˆ¶å™¨
      const controller: systemShare.ShareController = new systemShare.ShareController(shareData)
      const context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext

      // æ˜¾ç¤ºåˆ†äº«é¢æ¿
      await controller.show(context, {
        selectionMode: systemShare.SelectionMode.SINGLE,
        previewMode: systemShare.SharePreviewMode.DEFAULT
      })

      console.info('[MePage] Share panel opened successfully')
    } catch (error) {
      const err = error as BusinessError
      console.error(`[MePage] Failed to share app. code: ${err?.code}, message: ${err?.message}`)

      // å¦‚æœåˆ†äº«å¤±è´¥ï¼Œå›é€€åˆ°å¤åˆ¶åˆ°å‰ªè´´æ¿
      try {
        const isZh = this.currentLanguage.startsWith('zh')
        const shareText = isZh ? (
          'æ¨èä¸€ä¸ªè¶…æ£’çš„æ‘©å°”æ–¯ç”µç å­¦ä¹ åº”ç”¨ï¼ğŸ“Ÿâœ¨\nã€Šæ‘©æ–¯ç”µç é€šã€‹\n\nğŸ“± æ‘©æ–¯ç”µç é€š\nğŸ“ ä»é›¶å¼€å§‹å­¦ä¹ æ‘©å°”æ–¯ç”µç \nğŸ® è¶£å‘³ç»ƒä¹ ï¼Œè¾¹ç©è¾¹å­¦\nğŸ”¦ æ‰‹ç”µç­’é—ªçƒæ˜¾ç¤ºæ‘©å°”æ–¯ç \nğŸŒ™ æ”¯æŒæ·±è‰²æ¨¡å¼ï¼ŒæŠ¤çœ¼èˆ’é€‚\nğŸŒ æ”¯æŒç®€ç¹è‹±å¤šè¯­è¨€\n\nç«‹å³ä¸‹è½½ä½“éªŒï¼š\nhttps://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'
        ) : (
          'Highly recommend this great Morse code learning app! ğŸ“Ÿâœ¨\nMorse Code Trainer\n\nğŸ“± Learn Morse Code from scratch\nğŸ“ Step-by-step lessons for beginners\nğŸ® Fun practice modes\nğŸ”¦ Flashlight Morse code display\nğŸŒ™ Light and Dark themes\nğŸŒ Multi-language support\n\nTry it now:\nhttps://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'
        )

        const sysPB = pasteboard.getSystemPasteboard()
        const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, shareText)
        await sysPB.setPasteData(pasteData)

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        const message = isZh ? 'åˆ†äº«å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿' : 'Share content copied to clipboard'
        promptAction.showToast({
          message: message,
          duration: 2000,
          bottom: '80%'
        })
      } catch (toastError) {
        console.error('[MePage] Toast error:', toastError)
      }
    }
  }

  // æ‰“å¼€åº”ç”¨å¸‚åœºè¿›è¡Œè¯„åˆ†å’Œåé¦ˆ
  private async openAppGallery(): Promise<void> {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.morsecode'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openAppGalleryByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openAppGalleryByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºé¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openAppGalleryByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.morsecode'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('å¤‡é€‰æ–¹æ¡ˆå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  // æ‰“å¼€å…ƒç´ å‘¨æœŸè¡¨åº”ç”¨
  private openPeriodicTableApp(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.yuansu'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openPeriodicTableAppByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openPeriodicTableAppByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€å…ƒç´ å‘¨æœŸè¡¨åº”ç”¨é¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openPeriodicTableAppByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.yuansu'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  // æ‰“å¼€å…¨èƒ½è®¡åˆ†å™¨åº”ç”¨
  private openIScoreApp(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.jifen'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openIScoreAppByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openIScoreAppByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€å…¨èƒ½è®¡åˆ†å™¨åº”ç”¨é¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openIScoreAppByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.jifen'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  // æ‰“å¼€å¼€å‘åŠ©æ‰‹åº”ç”¨
  private openDevAssistantApp(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.kaifazhushou'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openDevAssistantAppByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openDevAssistantAppByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€å¼€å‘åŠ©æ‰‹åº”ç”¨é¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openDevAssistantAppByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.kaifazhushou'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  // æ‰“å¼€å›½æ——å°ç™¾ç§‘åº”ç”¨
  private openFlagApp(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.flag'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openFlagAppByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openFlagAppByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€å›½æ——å°ç™¾ç§‘åº”ç”¨é¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openFlagAppByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.flag'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  // æ‰“å¼€è´¢ä¼šå·¥å…·ç®±åº”ç”¨
  private openCaikuaiApp(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.caikuai'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openCaikuaiAppByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openCaikuaiAppByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€è´¢ä¼šå·¥å…·ç®±åº”ç”¨é¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openCaikuaiAppByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.caikuai'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  // æ‰“å¼€éšç§æ”¿ç­–é“¾æ¥
  private openPrivacyPolicy(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: this.privacyLink
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸ
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€éšç§æ”¿ç­–å¤±è´¥:', error)
      })
    } catch (error) {
      console.error('æ‰“å¼€éšç§æ”¿ç­–å¼‚å¸¸:', error)
    }
  }

  // æ‰“å¼€Rustä»å…¥é—¨åˆ°æ”¾å¼ƒåº”ç”¨
  private openRustApp(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        bundleName: 'com.huawei.appmarket',
        abilityName: 'com.huawei.appmarket.MainAbility',
        parameters: {
          appId: 'com.douhua.rustmaster'
        }
      }

      context.startAbility(want).then(() => {
        // æ‰“å¼€åº”ç”¨å¸‚åœºæˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        this.openRustAppByBrowser()
      })
    } catch (error) {
      console.error('æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      this.openRustAppByBrowser()
    }
  }

  // é€šè¿‡æµè§ˆå™¨æ‰“å¼€Rustä»å…¥é—¨åˆ°æ”¾å¼ƒåº”ç”¨é¡µé¢ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
  private openRustAppByBrowser(): void {
    try {
      const context = this.getUIContext().getHostContext() as common.UIAbilityContext
      const want: Want = {
        action: 'ohos.want.action.viewData',
        entities: ['entity.system.browsable'],
        uri: 'https://appgallery.huawei.com/app/detail?id=com.douhua.rustmaster'
      }

      context.startAbility(want).then(() => {
        // é€šè¿‡æµè§ˆå™¨æ‰“å¼€æˆåŠŸï¼Œæ— éœ€toastæç¤º
      }).catch((error: Error) => {
        console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¤±è´¥:', error)
        // æ‰“å¼€å¤±è´¥ï¼Œæ— éœ€toastæç¤º
      })
    } catch (error) {
      console.error('é€šè¿‡æµè§ˆå™¨æ‰“å¼€åº”ç”¨å¸‚åœºå¼‚å¸¸:', error)
      // å¼‚å¸¸æƒ…å†µï¼Œæ— éœ€toastæç¤º
    }
  }

  @State private showLanguageDialog: boolean = false

  @Builder ButtonModeSelectorDialog() {
    Column() {
      Row() {
        Text($r('app.string.select_practice_input_mode'))
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        Blank()
        Button() {
          Image($rawfile('ic_close.svg'))
            .width(20)
            .height(20)
            .fillColor('#FFFFFF')
        }
        .width(32)
          .height(32)
          .backgroundColor('rgba(128, 128, 128, 0.2)')
          .borderRadius(16)
          .onClick(() => {
            this.showButtonModeDialog = false
          })
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
      }
      .width('100%')
        .margin({ bottom: 20 })

      // åŒæŒ‰é’®æ¨¡å¼é€‰é¡¹
      Row() {
        Column() {
          Text($r('app.string.dual_button_mode'))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .margin({ bottom: 8 })
          Text($r('app.string.dual_button_mode_desc'))
            .fontSize(12)
            .fontColor('#999999')
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        if (!this.useSingleButton) {
          Circle()
            .width(16)
            .height(16)
            .fill(Color.Transparent)
            .stroke('#FFD700')
            .strokeWidth(2)
        }
      }
      .width('100%')
        .padding(16)
        .backgroundColor('#111111')
        .borderRadius(8)
        .margin({ bottom: 8 })
        .border({
          width: !this.useSingleButton ? 1 : 0.5,
          color: !this.useSingleButton ? '#FFD700' : '#222222',
          radius: 8
        })
        .onClick(() => {
          this.saveButtonModePreference(false)
          this.showButtonModeDialog = false
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // å•æŒ‰é’®æ¨¡å¼é€‰é¡¹
      Row() {
        Column() {
          Text($r('app.string.single_button_mode'))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .margin({ bottom: 8 })
          Text($r('app.string.single_button_mode_desc'))
            .fontSize(12)
            .fontColor('#999999')
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        if (this.useSingleButton) {
          Circle()
            .width(16)
            .height(16)
            .fill(Color.Transparent)
            .stroke('#FFD700')
            .strokeWidth(2)
        }
      }
      .width('100%')
        .padding(16)
        .backgroundColor('#111111')
        .borderRadius(8)
        .border({
          width: this.useSingleButton ? 1 : 0.5,
          color: this.useSingleButton ? '#FFD700' : '#222222',
          radius: 8
        })
        .onClick(() => {
          this.saveButtonModePreference(true)
          this.showButtonModeDialog = false
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)
    }
    .padding(20)
      .backgroundColor('#2A2A2A')
      .borderRadius(12)
      .width('90%')
      .constraintSize({ maxWidth: 400, maxHeight: '60%' })
  }

  @Builder LanguageSelectorDialog() {
    Column() {
      Row() {
        Text($r('app.string.language_selection_title'))
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        Blank()
        Button() {
          Image($rawfile('ic_close.svg'))
            .width(20)
            .height(20)
            .fillColor('#FFFFFF')
        }
        .width(32)
          .height(32)
          .backgroundColor('rgba(128, 128, 128, 0.2)')
          .borderRadius(16)
          .onClick(() => {
            this.showLanguageDialog = false
          })
          .hoverEffect(HoverEffect.Scale)
          .focusable(true)
      }
      .width('100%')
        .margin({ bottom: 20 })

      Column() {
        ForEach(SUPPORTED_LANGUAGES, (language: LanguageOption) => {
          Row() {
            Text(language.nativeName)
              .fontSize(16)
              .fontColor('#FFFFFF')
              .fontWeight(FontWeight.Medium)
              .layoutWeight(1)
              .alignSelf(ItemAlign.Start)

            if (this.currentLanguage === language.code) {
              Circle()
                .width(16)
                .height(16)
                .fill(Color.Transparent)
                .stroke('#FFD700')
                .strokeWidth(2)
            }
          }
          .width('100%')
            .padding(16)
            .backgroundColor('#111111')
            .borderRadius(8)
            .margin({ bottom: 8 })
            .border({
              width: this.currentLanguage === language.code ? 1 : 0.5,
              color: this.currentLanguage === language.code ? '#FFD700' : '#222222',
              radius: 8
            })
            .onClick(async () => {
              console.log(`[LANG_SELECT] User selected language: ${language.code}`)
              console.log(`[LANG_SELECT] Current language before change: ${this.currentLanguage}`)
              await this.setSystemLanguage(language.code)
              console.log(`[LANG_SELECT] Current language after change: ${this.currentLanguage}`)
              this.showLanguageDialog = false
            })
            .hoverEffect(HoverEffect.Scale)
            .focusable(true)
        })
      }
      .width('100%')
    }
    .padding(20)
      .backgroundColor('#2A2A2A')
      .borderRadius(12)
      .width('90%')
      .constraintSize({ maxWidth: 400, maxHeight: '60%' })
  }

  @Builder
  private TitleBar() {
    Row() {
      Text($r('app.string.settings'))
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
    }
    .height(56)
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .backgroundColor('#000000')
  }

  @Builder LanguageSettingsItem() {
    Row() {
      Column() {
        Text($r('app.string.language'))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

      Image($rawfile('ic_arrow_right.svg'))
        .width(16)
        .height(16)
        .fillColor('#666666')
    }
    .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.showLanguageDialog = true
      })
      .hoverEffect(HoverEffect.Scale)
      .focusable(true)
  }


  @Builder RatingSettingsItem() {
    Row() {
      Column() {
        Text($r('app.string.rating_feedback'))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

      Image($rawfile('ic_arrow_right.svg'))
        .width(16)
        .height(16)
        .fillColor('#666666')
    }
    .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.openAppGallery()
      })
      .hoverEffect(HoverEffect.Scale)
      .focusable(true)
  }

  @Builder ShareSettingsItem() {
    Row() {
      Column() {
        Text($r('app.string.share_app'))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

      Image($rawfile('ic_arrow_right.svg'))
        .width(16)
        .height(16)
        .fillColor('#666666')
    }
    .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.shareApp()
      })
      .hoverEffect(HoverEffect.Scale)
      .focusable(true)
  }

  @Builder PrivacyPolicySettingsItem() {
    Row() {
      Column() {
        Text($r('app.string.privacy_title'))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

      Image($rawfile('ic_arrow_right.svg'))
        .width(16)
        .height(16)
        .fillColor('#666666')
    }
    .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.openPrivacyPolicy()
      })
      .hoverEffect(HoverEffect.Scale)
      .focusable(true)
  }

  @Builder ButtonModeSettingsItem() {
    Row() {
      Column() {
        Text($r('app.string.practice_input_mode'))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

      Image($rawfile('ic_arrow_right.svg'))
        .width(16)
        .height(16)
        .fillColor('#666666')
    }
    .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .onClick(() => {
        this.showButtonModeDialog = true
      })
      .hoverEffect(HoverEffect.Scale)
      .focusable(true)
  }

  @Builder VibrationSettingsItem() {
    Row() {
      Column() {
        Text($r('app.string.vibration'))
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor('#FFFFFF')
          .textAlign(TextAlign.Start)
          .width('100%')
          .maxLines(1)
          .textOverflow({ overflow: TextOverflow.Ellipsis })
      }
      .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)

      Toggle({ type: ToggleType.Switch, isOn: this.vibrationEnabled })
        .selectedColor('#FFD700')
        .onChange(async (isOn: boolean) => {
          await this.saveVibrationPreference(isOn)
        })
    }
    .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .hoverEffect(HoverEffect.Scale)
      .focusable(true)
  }

  // æ‰‹ç”µç­’æµ‹è¯•UIå·²ç§»é™¤ï¼ˆåŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢ï¼‰
  /*
  @Builder FlashlightTestItem() { ... }
  @Builder SOSTestItem() { ... }
  */

  @Builder OtherAppsSection() {
    // å…¶ä»–åº”ç”¨éƒ¨åˆ†
    Column() {
      Text($r('app.string.other_apps'))
        .fontSize(14)
        .fontWeight(FontWeight.Normal)
        .fontColor('#999999')
        .margin({ top: 30, bottom: 12, left: 16 })
        .alignSelf(ItemAlign.Start)

      // å…¨èƒ½è®¡åˆ†å™¨åº”ç”¨å¡ç‰‡
      Row() {
        Image($rawfile('appicon_jifen.png'))
          .width(48)
          .height(48)
          .borderRadius(8)
          .margin({ right: 16 })

        Column() {
          Text(this.currentLanguage.startsWith('zh') ? 'å…¨èƒ½è®¡åˆ†å™¨' : 'iScore')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Start)
            .width('100%')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        Image($rawfile('ic_arrow_right.svg'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openIScoreApp()
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // å…ƒç´ å‘¨æœŸè¡¨åº”ç”¨å¡ç‰‡
      Row() {
        Image($r('app.media.appicon_yuansu'))
          .width(48)
          .height(48)
          .borderRadius(8)
          .margin({ right: 16 })

        Column() {
          Text($r('app.string.periodic_table_app'))
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Start)
            .width('100%')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        Image($rawfile('ic_arrow_right.svg'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openPeriodicTableApp()
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // å›½æ——å°ç™¾ç§‘åº”ç”¨å¡ç‰‡
      Row() {
        Image($rawfile('appicon_flag.png'))
          .width(48)
          .height(48)
          .borderRadius(8)
          .margin({ right: 16 })

        Column() {
          Text(this.currentLanguage.startsWith('zh') ? 'å›½æ——å°ç™¾ç§‘' : 'Flag Wiki')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Start)
            .width('100%')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        Image($rawfile('ic_arrow_right.svg'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openFlagApp()
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // å¼€å‘åŠ©æ‰‹åº”ç”¨å¡ç‰‡
      Row() {
        Image($rawfile('appicon_devassistant.png'))
          .width(48)
          .height(48)
          .borderRadius(8)
          .margin({ right: 16 })

        Column() {
          Text(this.currentLanguage.startsWith('zh') ? 'ç‹¬ç«‹å¼€å‘åŠ©æ‰‹' : 'Dev Assistant')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Start)
            .width('100%')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        Image($rawfile('ic_arrow_right.svg'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openDevAssistantApp()
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // è´¢ä¼šå·¥å…·ç®±åº”ç”¨å¡ç‰‡
      Row() {
        Image($rawfile('appicon_caikuai.png'))
          .width(48)
          .height(48)
          .borderRadius(8)
          .margin({ right: 16 })

        Column() {
          Text(this.currentLanguage.startsWith('zh') ? 'è´¢ä¼šå·¥å…·ç®±' : 'Accounting Tools')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Start)
            .width('100%')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        Image($rawfile('ic_arrow_right.svg'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openCaikuaiApp()
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)

      // Rustä»å…¥é—¨åˆ°æ”¾å¼ƒåº”ç”¨å¡ç‰‡
      Row() {
        Image($rawfile('appicon_rust.png'))
          .width(48)
          .height(48)
          .borderRadius(8)
          .margin({ right: 16 })

        Column() {
          Text(this.currentLanguage.startsWith('zh') ? 'Rust ä»å…¥é—¨åˆ°æ”¾å¼ƒ' : 'Rust Master')
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .fontColor('#FFFFFF')
            .textAlign(TextAlign.Start)
            .width('100%')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
        }
        .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

        Image($rawfile('ic_arrow_right.svg'))
          .width(16)
          .height(16)
          .fillColor('#666666')
      }
      .width('100%')
        .padding({ left: 16, right: 16, top: 12, bottom: 12 })
        .backgroundColor('#111111')
        .borderRadius(12)
        .border({ width: 1, color: '#222222' })
        .margin({ bottom: 8 })
        .onClick(() => {
          this.openRustApp()
        })
        .hoverEffect(HoverEffect.Scale)
        .focusable(true)
    }
    .width('100%')
      .alignItems(HorizontalAlign.Start)
      .constraintSize({ maxWidth: 400 })
  }


  build() {
    Column() {
      this.TitleBar()

      Stack() {
        Scroll() {
          Column() {
            // å¤´éƒ¨ - åº”ç”¨ä¿¡æ¯ï¼ˆé»‘è‰²èƒŒæ™¯ï¼Œå›¾æ ‡ç½®é¡¶ï¼‰
            Column() {
              Image($r('app.media.startIcon'))
                .width(80)
                .height(80)
                .borderRadius(20)
                .margin({ bottom: 16 })
                .shadow({
                  radius: 8,
                  color: 'rgba(255, 255, 255, 0.3)',
                  offsetX: 0,
                  offsetY: 2
                })

              Text($r('app.string.app_name'))
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor('#FFFFFF')
                .margin({ bottom: 4 })

              Row() {
                Text($r('app.string.version'))
                  .fontSize(14)
                  .fontColor('#B0B0B0')
                Text(` ${this.appVersion}`)
                  .fontSize(14)
                  .fontColor('#B0B0B0')
              }
            }
            .width('100%')
              .padding({ top: 20, bottom: 40 })
              .alignItems(HorizontalAlign.Center)

            // è®¾ç½®é¡¹ï¼ˆé»‘è‰²èƒŒæ™¯å¡ç‰‡ + åˆ†å‰²çº¿ï¼Œæ— å›¾æ ‡ï¼‰
            Column() {
              // ç›’å­å®¹å™¨
              Column() {
                // ç»ƒä¹ è¾“å…¥æ¨¡å¼è®¾ç½®
                this.ButtonModeSettingsItem()
                Divider().strokeWidth(1).color('#222222')

                // æŒ¯åŠ¨åé¦ˆè®¾ç½®
                this.VibrationSettingsItem()
                Divider().strokeWidth(1).color('#222222')

                // æ‰‹ç”µç­’æµ‹è¯•åŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢
                // this.FlashlightTestItem()
                // Divider().strokeWidth(1).color('#222222')

                // SOSæµ‹è¯•åŠŸèƒ½å·²ç§»è‡³ç¿»è¯‘é¡µé¢
                // this.SOSTestItem()
                // Divider().strokeWidth(1).color('#222222')

                // è¯­è¨€åˆ‡æ¢æ¡ç›®
                this.LanguageSettingsItem()
                Divider().strokeWidth(1).color('#222222')

                this.RatingSettingsItem()
                Divider().strokeWidth(1).color('#222222')

                this.ShareSettingsItem()
                Divider().strokeWidth(1).color('#222222')

                this.PrivacyPolicySettingsItem()
              }
              .width('100%')
                .backgroundColor('#111111')
                .borderRadius(12)
                .border({ width: 1, color: '#222222' })
                .padding({ top: 4, bottom: 4 })
                .constraintSize({ maxWidth: 400 })

              this.OtherAppsSection()
            }
            .width('100%')
              .padding({ left: 20, right: 20 })
              .alignItems(HorizontalAlign.Center)

            // åº•éƒ¨ç‰ˆæƒä¿¡æ¯ - ç°åœ¨åœ¨æ»šåŠ¨å†…å®¹çš„åº•éƒ¨
            Column() {
              // QQç¾¤ä¿¡æ¯ - ä»…åœ¨ä¸­æ–‡ç¯å¢ƒä¸‹æ˜¾ç¤º
              if (this.currentLanguage.startsWith('zh')) {
                Row() {
                  Text('QQç¾¤ï¼š825096333 ')
                    .fontSize(12)
                    .fontColor('#999999')

                  Image($rawfile('ic_copy.svg'))
                    .width(16)
                    .height(16)
                    .margin({ left: 4 })
                }
                .width('100%')
                  .justifyContent(FlexAlign.Center)
                  .alignItems(VerticalAlign.Center)
                  .padding({ bottom: 20 })
                  .onClick(async () => {
                    try {
                      const sysPB = pasteboard.getSystemPasteboard()
                      const pasteData = pasteboard.createData(pasteboard.MIMETYPE_TEXT_PLAIN, '825096333')
                      await sysPB.setPasteData(pasteData)
                      promptAction.showToast({
                        message: $r('app.string.qq_group_number_copied'),
                        duration: 2000
                      })
                    } catch (error) {
                      console.error('[MePage] Failed to copy QQ group number:', error)
                    }
                  })
              }

              Text($r('app.string.copyright'))
                .fontSize(12)
                .fontColor('#999999')
            }
            .width('100%')
              .padding({ top: 40, bottom: 20 })
              .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
            .backgroundColor('#000000')
        }
        .width('100%')
          .height('100%')
          .scrollBar(BarState.Off)
          .scrollable(ScrollDirection.Vertical)
          .scrollBarColor('#000000')
          .scrollBarWidth(0)
          .backgroundColor('#000000')

        // è¯­è¨€é€‰æ‹©å¯¹è¯æ¡†
        if (this.showLanguageDialog) {
          Stack() {
            // åŠé€æ˜èƒŒæ™¯
            Column()
              .width('100%')
              .height('100%')
              .backgroundColor('rgba(0, 0, 0, 0.5)')
              .onClick(() => {
                this.showLanguageDialog = false
              })

            // å¯¹è¯æ¡†å†…å®¹ - ä½¿ç”¨Columnå±…ä¸­
            Column() {
              this.LanguageSelectorDialog()
            }
            .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
            .height('100%')
        }

        // æŒ‰é’®æ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†
        if (this.showButtonModeDialog) {
          Stack() {
            // åŠé€æ˜èƒŒæ™¯
            Column()
              .width('100%')
              .height('100%')
              .backgroundColor('rgba(0, 0, 0, 0.5)')
              .onClick(() => {
                this.showButtonModeDialog = false
              })

            // å¯¹è¯æ¡†å†…å®¹ - ä½¿ç”¨Columnå±…ä¸­
            Column() {
              this.ButtonModeSelectorDialog()
            }
            .width('100%')
              .height('100%')
              .justifyContent(FlexAlign.Center)
              .alignItems(HorizontalAlign.Center)
          }
          .width('100%')
            .height('100%')
        }
      }
      .width('100%')
        .height('100%')
        .layoutWeight(1)
    }
    .width('100%')
      .height('100%')
      .backgroundColor('#000000')
      .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
