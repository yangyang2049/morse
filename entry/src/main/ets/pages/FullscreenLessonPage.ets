import { MorseCode, MorseCodeData } from '../models/MorseCode'
import { router } from '@kit.ArkUI'
import { LearnViewModel } from '../viewmodel/LearnViewModel'
import { LessonData } from '../data/LessonData'
import { promptAction } from '@kit.ArkUI'

@Entry
@Component
export struct FullscreenLessonPage {
  // è¯¾ç¨‹æ•°æ®
  private codes: MorseCode[] = []
  private lessonId: string = ''
  private title: string = ''
  
  // çŠ¶æ€ç®¡ç†
  @State currentIndex: number = 0
  @State userInput: string = ''
  @State showResult: boolean = false
  @State isCorrect: boolean = false
  @State showMorseCode: boolean = true
  @State completionCount: Map<number, number> = new Map()
  @State practiceCount: Map<number, number> = new Map() // æ¯ä¸ªå­—æ¯çš„ç»ƒä¹ æ¬¡æ•°
  private readonly REQUIRED_PRACTICE_COUNT: number = 5 // æ¯ä¸ªå­—æ¯éœ€è¦ç»ƒä¹ 5æ¬¡
  @State hintRevealed: Map<number, boolean> = new Map()
  // è‡ªåŠ¨æ ¡éªŒçš„é˜²æŠ–è®¡æ—¶å™¨
  private autoCheckTimer: number | null = null
  
  // ViewModel
  private learnViewModel: LearnViewModel = new LearnViewModel()

  aboutToAppear() {
    // ä»è·¯ç”±å‚æ•°è·å–è¯¾ç¨‹æ•°æ®
    const params = router.getParams() as Record<string, Object>
    this.lessonId = params['lessonId'] as string || ''
    this.title = params['title'] as string || 'ç»ƒä¹ è¯¾ç¨‹'
    
    // æ ¹æ®lessonIdè®¾ç½®è¯¾ç¨‹æ•°æ®
    this.setupLessonData()
    
    // åˆå§‹åŒ–ViewModel
    this.learnViewModel.init()
  }

  aboutToDisappear() {
    // æ¸…ç†æœªè§¦å‘çš„è‡ªåŠ¨æ ¡éªŒ
    if (this.autoCheckTimer !== null) {
      clearTimeout(this.autoCheckTimer)
      this.autoCheckTimer = null
    }
  }

  private setupLessonData() {
    // æ ¹æ®lessonIdè®¾ç½®ä¸åŒçš„è¯¾ç¨‹æ•°æ®ï¼ŒæŒ‰è¯¾ç¨‹é¡ºåºæ˜¾ç¤ºæŒ‡å®šå†…å®¹
    if (this.lessonId.includes('alpha_')) {
      // å­—æ¯è¯¾ç¨‹ï¼šæ ¹æ®è¯¾ç¨‹ç¼–å·æ˜¾ç¤ºç‰¹å®šå­—æ¯ç»„åˆ
      const lessonIndex = parseInt(this.lessonId.split('_')[1]) || 0
      const alphabetGroups = LessonData.getAlphabetGroups()
      if (lessonIndex < alphabetGroups.length) {
        const targetLetters = alphabetGroups[lessonIndex]
        this.codes = MorseCodeData.englishAlphabet.filter(code => 
          targetLetters.includes(code.character)
        )
      } else {
        this.codes = MorseCodeData.englishAlphabet.slice(0, 3) // é»˜è®¤ABC
      }
    } else if (this.lessonId.includes('num_')) {
      // æ•°å­—è¯¾ç¨‹ï¼šæ ¹æ®è¯¾ç¨‹ç¼–å·æ˜¾ç¤ºç‰¹å®šæ•°å­—ç»„åˆ
      const lessonIndex = parseInt(this.lessonId.split('_')[1]) || 0
      const numberGroups = LessonData.getNumberGroups()
      if (lessonIndex < numberGroups.length) {
        const targetNumbers = numberGroups[lessonIndex]
        this.codes = MorseCodeData.numbers.filter(code => 
          targetNumbers.includes(code.character)
        )
      } else {
        this.codes = MorseCodeData.numbers.slice(0, 3) // é»˜è®¤123
      }
    } else if (this.lessonId.includes('pun_')) {
      // æ ‡ç‚¹è¯¾ç¨‹ï¼šæ ¹æ®è¯¾ç¨‹ç¼–å·æ˜¾ç¤ºç‰¹å®šæ ‡ç‚¹ç»„åˆ
      const lessonIndex = parseInt(this.lessonId.split('_')[1]) || 0
      const punctuationGroups = LessonData.getPunctuationGroups()
      if (lessonIndex < punctuationGroups.length) {
        const targetPunctuation = punctuationGroups[lessonIndex]
        this.codes = MorseCodeData.punctuation.filter(code => 
          targetPunctuation.includes(code.character)
        )
      } else {
        this.codes = MorseCodeData.punctuation.slice(0, 3) // é»˜è®¤å‰3ä¸ª
      }
    } else if (this.lessonId.includes('word_')) {
      // å•è¯è¯¾ç¨‹ï¼šæ ¹æ®è¯¾ç¨‹ç¼–å·æ˜¾ç¤ºç‰¹å®šé•¿åº¦å•è¯
      const lessonIndex = parseInt(this.lessonId.split('_')[1]) || 0
      const wordGroups = LessonData.getWordGroups()
      if (lessonIndex < wordGroups.length) {
        const targetWords = wordGroups[lessonIndex]
        // å°†å•è¯è½¬æ¢ä¸ºMorseCodeå¯¹è±¡
        this.codes = targetWords.map(word => new MorseCode(word, '', ''))
      } else {
        this.codes = [new MorseCode('THE', '', ''), new MorseCode('AND', '', ''), new MorseCode('FOR', '', '')]
      }
    } else {
      // é»˜è®¤æ˜¾ç¤ºå‰3ä¸ªå­—æ¯
      this.codes = MorseCodeData.englishAlphabet.slice(0, 3)
    }
  }

  private addDot(): void {
    this.userInput += '.'
    this.showResult = false
    this.startAutoCheck()
  }

  private addDash(): void {
    this.userInput += '-'
    this.showResult = false
    this.startAutoCheck()
  }

  private clearInput(): void {
    this.userInput = ''
    this.showResult = false
    this.isCorrect = false
    // å–æ¶ˆæœªè§¦å‘çš„è‡ªåŠ¨æ ¡éªŒï¼Œé¿å…æ¸…ç©ºåç«‹å³æ ¡éªŒ
    if (this.autoCheckTimer !== null) {
      clearTimeout(this.autoCheckTimer)
      this.autoCheckTimer = null
    }
  }

  private startAutoCheck(): void {
    // é˜²æŠ–ï¼šåœ¨ç”¨æˆ·è¾“å…¥åœæ­¢600msåè‡ªåŠ¨æ ¡éªŒ
    if (this.autoCheckTimer !== null) {
      clearTimeout(this.autoCheckTimer)
      this.autoCheckTimer = null
    }
    this.autoCheckTimer = setTimeout(() => {
      this.autoCheckTimer = null
      this.checkAnswer()
    }, 600)
  }

  private shouldShowHint(index: number): boolean {
    const isReviewLesson = this.codes.length > 10
    if (isReviewLesson) {
      return this.hintRevealed.get(index) || false
    } else {
      return this.showMorseCode
    }
  }

  private checkAnswer(): void {
    const currentCode = this.codes[this.currentIndex]
    const isCorrect = this.userInput === currentCode.morse

    this.isCorrect = isCorrect
    this.showResult = true

    if (isCorrect) {
      // å¢åŠ ç»ƒä¹ æ¬¡æ•°
      const currentPracticeCount = this.practiceCount.get(this.currentIndex) || 0
      this.practiceCount.set(this.currentIndex, currentPracticeCount + 1)

      // æ£€æŸ¥æ˜¯å¦å®Œæˆ5æ¬¡ç»ƒä¹ 
      if (this.practiceCount.get(this.currentIndex)! >= this.REQUIRED_PRACTICE_COUNT) {
        // æ ‡è®°ä¸ºå®Œæˆ
        this.completionCount.set(this.currentIndex, 1)
        setTimeout(() => {
          this.moveToNext()
        }, 1000)
      } else {
        // ç»§ç»­å½“å‰å­—æ¯ï¼Œæ¸…ç©ºè¾“å…¥
        setTimeout(() => {
          this.clearInput()
        }, 1000)
      }
    } else {
      // é”™è¯¯æ—¶æ˜¾ç¤ºç³»ç»Ÿtoast
      promptAction.showToast({
        message: 'å†è¯•ä¸€æ¬¡',
        duration: 1500
      })
      setTimeout(() => {
        this.clearInput()
      }, 1500)
    }
  }

  private moveToNext(): void {
    if (this.currentIndex < this.codes.length - 1) {
      this.currentIndex++
      this.clearInput()
    } else {
      // æ‰€æœ‰å­—æ¯éƒ½å®Œæˆäº†
      this.showCompletionDialog()
    }
  }

  private async markLessonCompleted(): Promise<void> {
    if (this.lessonId) {
      await this.learnViewModel.markLessonCompleted(this.lessonId)
    }
  }

  private showCompletionDialog(): void {
    // æ ‡è®°è¯¾ç¨‹ä¸ºå·²å®Œæˆ
    this.markLessonCompleted()
    
    // æ˜¾ç¤ºå®Œæˆå¯¹è¯æ¡†
    AlertDialog.show({
      title: 'æ­å–œå®Œæˆï¼',
      message: `å®Œæˆäº† ${this.codes.length} ä¸ªå­—æ¯çš„ç»ƒä¹ `,
      primaryButton: {
        value: 'è¿”å›',
        action: () => {
          router.back()
        }
      },
      secondaryButton: {
        value: 'å†æ¬¡ç»ƒä¹ ',
        action: () => {
          this.currentIndex = 0
          this.completionCount.clear()
          this.clearInput()
        }
      }
    })
  }

  @Builder
  private TitleBar() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button() {
          Text('â†')
            .fontSize(24)
            .fontColor(Color.White)
        }
        .backgroundColor(Color.Transparent)
        .onClick(() => {
          router.back()
        })

        Row() {
          ForEach(this.codes, (code: MorseCode, index: number) => {
            Text(code.character)
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.getLetterStatusColor(index))
              .margin({ right: 8 })
          })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)

        // æç¤ºæŒ‰é’®ï¼ˆä»…åœ¨éå¤ä¹ è¯¾æ—¶æ˜¾ç¤ºï¼‰
        if (this.codes.length <= 10) {
          Button() {
            Text(this.showMorseCode ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸')
              .fontSize(20)
              .fontColor(Color.White)
          }
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.showMorseCode = !this.showMorseCode
          })
        } else {
          // å¤ä¹ è¯¾æ—¶æ˜¾ç¤ºå ä½
          Blank().width(48)
        }
      }
      .height(52)
      .padding({ left: 16, right: 16 })


    }
    .width('100%')
    .backgroundColor(Color.Black)
  }

  @Builder
  private ProgressCircle() {
    Stack({ alignContent: Alignment.Center }) {
      // èƒŒæ™¯åœ†åœˆ
      Circle({ width: 220, height: 220 })
        .fill(Color.Transparent)
        .strokeWidth(8)
        .stroke('#333333')
      
      // è¿›åº¦åœ†åœˆï¼ˆèµ·ç‚¹è°ƒæ•´åˆ°é¡¶éƒ¨ä¸­å¿ƒï¼šåç§»å››åˆ†ä¹‹ä¸€å‘¨é•¿ï¼‰
      Circle({ width: 220, height: 220 })
        .fill(Color.Transparent)
        .strokeWidth(8)
        .stroke(this.getProgressColor())
        .strokeDashArray([this.getProgressLength(), this.getCircumference()])
        .strokeDashOffset(this.getCircumference() / 4)
        .strokeLineCap(LineCapStyle.Round)
        .opacity(this.getProgressLength() > 0 ? 1 : 0) // è¿›åº¦ä¸º0æ—¶ä¸æ˜¾ç¤º
        .animation({
          duration: 500,
          curve: Curve.EaseInOut
        })
      
      // å†…éƒ¨åœ†åœˆ
      Circle({ width: 200, height: 200 })
        .fill(this.getProgressColor())
        .animation({
          duration: 500,
          curve: Curve.EaseInOut
        })
      
      // å­—ç¬¦
      Text(this.codes[this.currentIndex]?.character || '')
        .fontSize(80)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.isCompleted() ? Color.White : '#1A1A1A')
    }
  }

  private getProgressColor(): ResourceColor {
    const isCompleted = this.isCompleted()
    return isCompleted ? Color.Green : '#FFD700'
  }

  private getCircumference(): number {
    // åŠå¾„å›ºå®šä¸º110ï¼ˆè§ProgressCircleä¸­Circleå°ºå¯¸ï¼‰ï¼Œç”¨äºè®¡ç®—æè¾¹é•¿åº¦å’Œåç§»é‡
    return 2 * Math.PI * 110
  }

  private isCompleted(): boolean {
    const currentPracticeCount = this.practiceCount.get(this.currentIndex) || 0
    return currentPracticeCount >= this.REQUIRED_PRACTICE_COUNT
  }

  private getProgressLength(): number {
    const currentPracticeCount = this.practiceCount.get(this.currentIndex) || 0
    const progress = Math.min(currentPracticeCount / this.REQUIRED_PRACTICE_COUNT, 1)
    return 2 * Math.PI * 110 * progress
  }

  @Builder
  private MorseDisplay() {
    Column() {
      Text(this.shouldShowHint(this.currentIndex) ? 
        (this.codes[this.currentIndex]?.morse || '').replace(/\./g, 'Â·') : '?')
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.shouldShowHint(this.currentIndex) ? Color.White : '#FFFFFF80')
        .fontFamily('monospace')
        .letterSpacing(2)
    }
    .height(80)
    .width(150)
    .backgroundColor('#1A1A1A')
    .borderRadius(20)
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  private InputDisplay() {
    Stack({ alignContent: Alignment.Center }) {
      // ä¸»è¦è¾“å…¥æ–‡æœ¬
      Text(this.userInput.replace(/\./g, 'Â·'))
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontColor(
          this.showResult && this.isCorrect ? Color.Green :
          this.userInput.length === 0 ? Color.Transparent : '#FFD700'
        )
        .fontFamily('monospace')
        .letterSpacing(4)
      
      // é”™è¯¯æ—¶çš„çº¢è‰²æ–‡æœ¬
      if (this.showResult && !this.isCorrect) {
        Text(this.userInput.replace(/\./g, 'Â·'))
          .fontSize(36)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Red)
          .fontFamily('monospace')
          .letterSpacing(4)
      }
    }
    .height(60)
    .width('100%')
  }





  private getLessonLetters(): string {
    // è·å–å½“å‰è¯¾ç¨‹çš„æ‰€æœ‰å­—æ¯ï¼Œç”¨ç©ºæ ¼åˆ†éš”
    return this.codes.map(code => code.character).join(' ')
  }

  private getLetterStatusColor(index: number): ResourceColor {
    const currentPracticeCount = this.practiceCount.get(index) || 0
    const isCompleted = currentPracticeCount >= this.REQUIRED_PRACTICE_COUNT
    const isActive = index === this.currentIndex
    
    if (isCompleted) {
      return Color.Green  // å·²å®Œæˆï¼šç»¿è‰²
    } else if (isActive) {
      return '#FFD700'    // å½“å‰å­—æ¯ï¼šé»„è‰²
    } else {
      return Color.White  // å…¶ä»–å­—æ¯ï¼šç™½è‰²
    }
  }



  @Builder
  private BottomKeys() {
    Row() {
      // ç‚¹ (çŸ­éŸ³)
      Button() {
        Circle({ width: 20, height: 20 })
          .fill('#FFD700')
      }
      .height(80)
      .backgroundColor('#1A1A1A')
      .borderRadius(20)
      .border({ width: 1, color: '#333333' })
      .onClick(() => this.addDot())
      .layoutWeight(1)

      Blank().width(20)

      // åˆ’ (é•¿éŸ³)
      Button() {
        Rect({ width: 40, height: 12 })
          .fill('#FFD700')
      }
      .height(80)
      .backgroundColor('#1A1A1A')
      .borderRadius(20)
      .border({ width: 1, color: '#333333' })
      .onClick(() => this.addDash())
      .layoutWeight(1)
    }
    .padding({ left: 20, right: 20, bottom: 20 })
  }

  build() {
    Column() {
      this.TitleBar()

      Blank().height(20)

      // ä¸»è¦å†…å®¹åŒºåŸŸ
      Column() {
        this.ProgressCircle()
        Blank().height(60)
        this.MorseDisplay()
        Blank().height(20)
        this.InputDisplay()
      }
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)



      this.BottomKeys()
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }
}
