interface LessonItem {
  key: string
  title: string
  subtitle?: string
  unlocked: boolean
  unitUnlocked: boolean
  completed: boolean
}

@Component
export struct LearnPage {
  private scroller: Scroller = new Scroller()

  private introLessons(): LessonItem[] {
    return [
      { key: 'intro_0', title: 'ç¬¬1è¯¾ï¼šæ‘©æ–¯å¯†ç åŸºç¡€', subtitle: 'ç‚¹åˆ’ã€é—´éš”ã€å†å²ä¸åº”ç”¨', unlocked: true, unitUnlocked: true, completed: false },
      { key: 'intro_1', title: 'ç¬¬2è¯¾ï¼šä¸­æ–‡æ‘©å°”æ–¯ç”µç ', subtitle: 'æ±‰å­—ç¼–ç ã€æ ‡ç‚¹ç¬¦å·ã€åº”ç”¨åœºæ™¯', unlocked: true, unitUnlocked: true, completed: false },
      { key: 'intro_p1', title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false },
      { key: 'intro_p2', title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false },
      { key: 'intro_p2', title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false },

    ]
  }

  private alphabetLessons(): LessonItem[] {
    const items: LessonItem[] = []
    const subtitles: string[] = ['ABC', 'DEF', 'GHIJ', 'å¤ä¹ ï¼šA-J', 'KLMN', 'OPQR', 'STUV', 'WXYZ', 'å¤ä¹ ï¼šK-Z']
    for (let i = 0; i < 9; i++) {
      const isReview = i === 3 || i === 8
      items.push({
        key: `alpha_${i}`,
        title: isReview ? `ç¬¬${i + 1}è¯¾ï¼šå¤ä¹ ` : `ç¬¬${i + 1}è¯¾`,
        subtitle: subtitles[i],
        unlocked: i === 0,
        unitUnlocked: true,
        completed: false
      })
    }
    return items
  }

  private numberLessons(): LessonItem[] {
    const subtitles: string[] = ['1 2 3', '4 5 6', '7 8 9 0', 'å¤ä¹ ï¼š0-9']
    const items: LessonItem[] = []
    for (let i = 0; i < 4; i++) {
      const isReview = i === 3
      items.push({
        key: `num_${i}`,
        title: isReview ? `ç¬¬${i + 1}è¯¾ï¼šå¤ä¹ ` : `ç¬¬${i + 1}è¯¾`,
        subtitle: subtitles[i],
        unlocked: i === 0,
        unitUnlocked: true,
        completed: false
      })
    }
    // Pad up to 4 (no more) for consistent alignment
    while (items.length < 5) {
      items.push({ key: `num_p${items.length}`, title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false })
    }
    return items
  }

  private punctuationLessons(): LessonItem[] {
    const subtitles: string[] = ['., ? ! : ;', '= + - _ " \' , ( ) / @', 'å¤ä¹ ']
    const items: LessonItem[] = []
    for (let i = 0; i < 3; i++) {
      items.push({
        key: `pun_${i}`,
        title: `ç¬¬${i + 1}è¯¾`,
        subtitle: subtitles[i],
        unlocked: i === 0,
        unitUnlocked: true,
        completed: false
      })
    }
    // Pad up to 4 entries
    while (items.length < 5) {
      items.push({ key: `pun_p${items.length}`, title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false })
    }
    return items
  }

  private wordLessons(): LessonItem[] {
    const items: LessonItem[] = [
      { key: 'word_0', title: 'ç¬¬1è¯¾', subtitle: '3å­—æ¯å•è¯', unlocked: true, unitUnlocked: true, completed: false },
      { key: 'word_1', title: 'ç¬¬2è¯¾', subtitle: '4å­—æ¯å•è¯', unlocked: false, unitUnlocked: true, completed: false },
      { key: 'word_2', title: 'ç¬¬3è¯¾', subtitle: '5å­—æ¯å•è¯', unlocked: false, unitUnlocked: true, completed: false },
      { key: 'intro_p2', title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false },
      { key: 'intro_p2', title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false },

    ]
    while (items.length < 4) {
      items.push({ key: `word_p${items.length}`, title: 'å ä½', unlocked: false, unitUnlocked: false, completed: false })
    }
    return items
  }

  @Builder
  private LessonCard(item: LessonItem) {
    Row() {
      Column() {
        Text(item.title)
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(item.unlocked ? Color.White : '#FFFFFF99')
          .margin({ bottom: item.subtitle ? 8 : 0 })

        if (item.subtitle) {
          Text(item.subtitle)
            .fontSize(14)
            .fontColor(item.unlocked ? '#B0B0B0' : '#FFFFFF80')
        }
      }
      .layoutWeight(1)

      if (item.completed) {
        Text('âœ“').fontSize(20).fontColor(Color.Green)
      } else if (item.unlocked) {
        Text('â€º').fontSize(16).fontColor(Color.White)
      } else if (item.unitUnlocked) {
        Text('ğŸ”’').fontSize(16).fontColor('#FFFFFF80')
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#1A1A1A')
    .border({ width: 1, color: '#333333' })
    .borderRadius(12)
  }

  @Builder
  private UnitCard(title: string, unitNumber: number, lessons: LessonItem[], isUnlocked: boolean) {
    RelativeContainer() {
      // Reference anchor filling the card (use empty Column due to Blank restriction)
      Column() {}
        .id('card')
        .width('100%')
        .height('100%')

      // Big faded number anchored to bottom-right of the card
      Text(`${unitNumber}`)
        .fontSize(80)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .opacity(0.25)  // 25% opacity
        .alignRules({
          bottom: { anchor: 'card', align: VerticalAlign.Bottom },
          right:  { anchor: 'card', align: HorizontalAlign.End }
        })
        .margin({ right: 0, bottom: -10 })  // Negative bottom margin to move it closer
        .zIndex(0)

      Column()
        .alignRules({
          top:  { anchor: 'card', align: VerticalAlign.Top },
          left: { anchor: 'card', align: HorizontalAlign.Start }
        })
        .zIndex(1)
      {
        Row() {
          Text(title)
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
          if (!isUnlocked) {
            Text('ğŸ”’').fontSize(24).fontColor('#FFFFFF99')
          }
        }
        .margin({ top: 24, bottom: 32 })

        // Lessons list (scroll within card); render placeholders with opacity 0 to keep vertical alignment
        Scroll() {
          Column() {
            ForEach(lessons, (l: LessonItem, idx: number) => {
              Column() {
                this.LessonCard(l)
                if (idx < lessons.length - 1) { Blank().height(12) }
              }
              .opacity(l.title === 'å ä½' ? 0.0 : 1.0)
            }, (l: LessonItem) => l.key)
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)  // ç§»é™¤æ»šåŠ¨æ¡
        .edgeEffect(EdgeEffect.Spring)  // æ·»åŠ å¼¹æ€§æ•ˆæœ
        .opacity(isUnlocked ? 1.0 : 0.45)
      }
    }
    .padding(16)
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A1A')
    .border({ width: 1, color: '#333333' })
    .borderRadius(12)
  }

  build() {
    Column() {
      // Title bar
      Row() {
        Text('å­¦ä¹ ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .layoutWeight(1)
          .textAlign(TextAlign.Center)
      }
      .height(52)
      .padding({ left: 16, right: 16 })
      .backgroundColor(Color.Black)

      // Horizontal scroll of unit cards
      Scroll(this.scroller) {
        Row() {
          // Intro unit (2 lessons + padding)
          Column() { this.UnitCard('æ‘©æ–¯å¯†ç åŸºç¡€', 1, this.introLessons(), true) }
            .width(320).height(500).margin({ right: 16 })

          // Alphabet unit (9)
          Column() { this.UnitCard('å­—æ¯', 2, this.alphabetLessons(), true) }
            .width(320).height(500).margin({ right: 16 })

          // Numbers unit (4)
          Column() { this.UnitCard('æ•°å­—', 3, this.numberLessons(), true) }
            .width(320).height(500).margin({ right: 16 })

          // Punctuation unit (3 + pad)
          Column() { this.UnitCard('ç¬¦å·', 4, this.punctuationLessons(), true) }
            .width(320).height(500).margin({ right: 16 })

          // Words unit (3 + pad)
          Column() { this.UnitCard('å•è¯', 5, this.wordLessons(), true) }
            .width(320).height(500)
        }
      }
      .scrollable(ScrollDirection.Horizontal)
      .edgeEffect(EdgeEffect.Spring)
      .scrollBar(BarState.Auto)
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 16, bottom: 24 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
  }
}
