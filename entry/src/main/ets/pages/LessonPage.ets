import { router } from '@kit.ArkUI'
import window from '@ohos.window'

@Entry
@Component
export struct LessonPage {
  @State title: string = 'æ‘©æ–¯å¯†ç åŸºç¡€è¯¾ç¨‹'
  @State sections: Map<string, string[]> = new Map()
  @State testType: string = 'intro'
  @State testTitle: string = 'åŸºç¡€çŸ¥è¯†æµ‹è¯•'
  @State testCompletedKey: string = 'intro_test_completed'
  @State lessonCompletedKey: string = 'intro_lesson_completed'
  @State currentPageIndex: number = 0

  aboutToAppear() {
    // Set status bar color
    window.getLastWindow(getContext(this)).then((windowClass) => {
      windowClass.setWindowSystemBarProperties({
        statusBarColor: '#1A1A1A',
        isStatusBarLightIcon: false
      })
    })

    // Initialize sections based on test type
    this.initializeSections()
  }

  initializeSections() {
    if (this.testType === 'intro') {
      this.sections = new Map([
        ['æ‘©æ–¯å¯†ç åŸºç¡€', [
          'æ‘©æ–¯å¯†ç æ˜¯ä»¥"ç‚¹ï¼ˆÂ·ï¼‰å’Œåˆ’ï¼ˆ-ï¼‰"ä¸ºåŸºæœ¬å…ƒç´ çš„å­—ç¬¦ç¼–ç ç³»ç»Ÿã€‚',
          'é€šè¿‡ä¸åŒçš„ç‚¹åˆ’ç»„åˆæ¥è¡¨ç¤ºå­—æ¯ã€æ•°å­—å’Œç¬¦å·ã€‚',
          'æ¯ä¸ªå­—ç¬¦éƒ½æœ‰å”¯ä¸€çš„æ‘©æ–¯å¯†ç è¡¨ç¤ºã€‚'
        ]],
        ['å­—ç¬¦æ„æˆè§„å¾‹', [
          'ç‚¹ï¼ˆÂ·ï¼‰ï¼šçŸ­ä¿¡å·ï¼Œé€šå¸¸æŒç»­1ä¸ªå•ä½æ—¶é—´',
          'åˆ’ï¼ˆ-ï¼‰ï¼šé•¿ä¿¡å·ï¼Œé€šå¸¸æŒç»­3ä¸ªå•ä½æ—¶é—´',
          'å­—ç¬¦é—´éš”ï¼š3ä¸ªå•ä½æ—¶é—´',
          'å•è¯é—´éš”ï¼š7ä¸ªå•ä½æ—¶é—´'
        ]],
        ['æ—¶åºè§„åˆ™', [
          '1:3:7æ¯”ä¾‹æ˜¯æ‘©æ–¯å¯†ç çš„æ ¸å¿ƒè§„åˆ™',
          'ç‚¹=1å•ä½ï¼Œåˆ’=3å•ä½ï¼Œå­—ç¬¦é—´éš”=3å•ä½ï¼Œå•è¯é—´éš”=7å•ä½',
          'è¿™ä¸ªç²¾ç¡®çš„æ—¶åºç¡®ä¿äº†ä¿¡æ¯ä¼ è¾“çš„å‡†ç¡®æ€§'
        ]],
        ['åº”ç”¨åœºæ™¯', [
          'å†›äº‹é€šä¿¡ï¼šéƒ¨é˜Ÿé—´çš„ç§˜å¯†é€šä¿¡',
          'èˆªç©ºé€šä¿¡ï¼šé£è¡Œå‘˜ä¸åœ°é¢æ§åˆ¶å¡”é€šä¿¡',
          'èˆªæµ·é€šä¿¡ï¼šèˆ¹èˆ¶é—´é€šä¿¡',
          'ç´§æ€¥æ±‚æ•‘ï¼šSOSä¿¡å·'
        ]]
      ])
    } else if (this.testType === 'chinese') {
      this.sections = new Map([
        ['ä¸­æ–‡æ‘©å°”æ–¯ç”µç åŸºç¡€', [
          'ä¸­æ–‡æ‘©å°”æ–¯ç”µç æ˜¯ä¸“é—¨ä¸ºä¸­æ–‡æ±‰å­—è®¾è®¡çš„ç¼–ç ç³»ç»Ÿã€‚',
          'é€šè¿‡ç‚¹ï¼ˆÂ·ï¼‰å’Œåˆ’ï¼ˆ-ï¼‰çš„ç»„åˆè¡¨ç¤ºä¸­æ–‡å­—ç¬¦ã€‚',
          'ç»“åˆäº†ä¼ ç»Ÿæ‘©å°”æ–¯ç”µç åŸç†å’Œä¸­æ–‡è¯­è¨€ç‰¹ç‚¹ã€‚'
        ]],
        ['ç¼–ç ç‰¹ç‚¹', [
          'ä¸­æ–‡ç¼–ç é€šå¸¸æ¯”è‹±æ–‡æ›´é•¿',
          'æ¯ä¸ªæ±‰å­—éƒ½æœ‰å”¯ä¸€çš„æ‘©å°”æ–¯ç”µç è¡¨ç¤º',
          'ç¼–ç é•¿åº¦å¢åŠ æ˜¯ä¸ºäº†ç¡®ä¿å­—ç¬¦çš„å”¯ä¸€æ€§'
        ]],
        ['å†å²å‘å±•', [
          '1920å¹´ä»£ï¼šåˆæ­¥åˆ¶å®šä¸­æ–‡æ‘©å°”æ–¯ç”µç æ ‡å‡†',
          'å›½é™…ç”µä¿¡è”ç›Ÿï¼ˆITUï¼‰å‚ä¸åˆ¶å®š',
          'ç»è¿‡å¤šæ¬¡ä¼˜åŒ–å½¢æˆç°ä»£æ ‡å‡†'
        ]],
        ['åº”ç”¨åœºæ™¯', [
          'å†›äº‹é€šä¿¡ï¼šéƒ¨é˜Ÿé—´çš„ç§˜å¯†é€šä¿¡',
          'èˆªç©ºé€šä¿¡ï¼šé£è¡Œå‘˜ä¸åœ°é¢æ§åˆ¶å¡”é€šä¿¡',
          'èˆªæµ·é€šä¿¡ï¼šèˆ¹èˆ¶é—´é€šä¿¡'
        ]]
      ])
    }
  }

  @Builder
  TitleBar() {
    Row() {
      Button() {
        Text('è¿”å›')
          .fontSize(16)
          .fontColor(Color.White)
      }
      .width(48)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back()
      })

      Text(this.title)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button()
        .width(48)
        .height(48)
        .backgroundColor(Color.Transparent)
        .enabled(false)
    }
    .height(52)
    .padding({ left: 16, right: 16 })
    .backgroundColor('#1A1A1A')
  }

  @Builder
  buildBulletLine(text: string) {
    Row() {
      Text('â€¢ ')
        .fontColor('#FFFFFFB3')
      Text(text)
        .layoutWeight(1)
        .fontColor('#FFFFFF')
    }
    .alignItems(VerticalAlign.Top)
  }

  @Builder
  buildDefaultSection(title: string, contents: string[]) {
    Column() {
      ForEach(contents, (content: string, index: number) => {
        Column() {
          this.buildBulletLine(content)
          if (index < contents.length - 1) {
            Blank().height(8)
          }
        }
      })
    }
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Start)
    .width('100%')
    .align(Alignment.TopStart)
  }

  @Builder
  buildSectionCard(title: string, contents: string[], index: number) {
    Column() {
      Stack() {
        // Big faded number at bottom right
        Text(`${index + 1}`)
          .fontSize(80)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .opacity(0.1)
          .align(Alignment.BottomEnd)
          .margin({ right: 8, bottom: 8 })

        // Main content
        Column() {
          Text(title)
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .margin({ bottom: 24 })
            .alignSelf(ItemAlign.Start)

          Scroll() {
            this.buildDefaultSection(title, contents)
          }
          .layoutWeight(1)
          .scrollBar(BarState.Off)
          .edgeEffect(EdgeEffect.Spring)
        }
        .alignItems(HorizontalAlign.Start)
        .justifyContent(FlexAlign.Start)
        .width('100%')
        .height('100%')
      }
    }
    .width(320)
    .height(480)
    .padding(16)
    .backgroundColor('#1A1A1A')
    .border({ width: 1, color: '#333333' })
    .borderRadius(12)
    .margin({ right: 16 })
  }

  @Builder
  buildTestCard() {
    Column() {
      Row() {
        Text('ğŸ“‹').fontSize(24).margin({ right: 8 })
        Text(this.testTitle)
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FF8C00')
          .alignSelf(ItemAlign.Center)
      }
      .margin({ bottom: 32 })

      Text(`æµ‹è¯•ä½ å¯¹${this.title}çš„æŒæ¡ç¨‹åº¦`)
        .fontSize(16)
        .fontColor('#FF8C00')
        .margin({ bottom: 32 })

      Text('æµ‹è¯•å†…å®¹')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF8C00')
        .margin({ bottom: 8 })
        .alignSelf(ItemAlign.Start)

      Column() {
        Text('â€¢ 2é“åˆ¤æ–­é¢˜ï¼ˆæ¯é¢˜20åˆ†ï¼‰').fontSize(14).fontColor(Color.Black).margin({ bottom: 4 })
        Text('â€¢ 3é“é€‰æ‹©é¢˜ï¼ˆæ¯é¢˜20åˆ†ï¼‰').fontSize(14).fontColor(Color.Black).margin({ bottom: 4 })
        Text('â€¢ éœ€è¦100åˆ†æ‰èƒ½é€šè¿‡').fontSize(14).fontColor(Color.Black)
      }
      .margin({ bottom: 32 })
      .alignItems(HorizontalAlign.Start)

      Blank().layoutWeight(1)

      Button() {
        Row() {
          Text('â–¶').fontSize(16).fontColor(Color.White).margin({ right: 8 })
          Text('å¼€å§‹æµ‹è¯•')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
        }
      }
      .width('100%')
      .height(48)
      .backgroundColor('#FF8C00')
      .borderRadius(8)
      .onClick(() => {
        // Navigate to quiz page
        router.pushUrl({
          url: 'pages/LessonQuizPage',
          params: {
            testType: this.testType,
            pageTitle: this.testTitle,
            testCompletedKey: this.testCompletedKey
          }
        })
      })

      Blank().height(24)
    }
    .alignItems(HorizontalAlign.Start)
    .justifyContent(FlexAlign.Start)
    .width(320)
    .height(480)
    .padding(16)
    .backgroundColor('#FFF8DC')
    .border({ width: 1, color: '#FF8C00' })
    .borderRadius(12)
  }

  build() {
    Column() {
      this.TitleBar()

      // PageView style with horizontal scrolling cards
      Scroll() {
        Row() {
          // Section cards
          ForEach(Array.from(this.sections.keys()), (title: string, index: number) => {
            this.buildSectionCard(title, this.sections.get(title) || [], index)
          })

          // Test card
          this.buildTestCard()
        }
        .alignItems(VerticalAlign.Top)
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .layoutWeight(1)
      .padding({ left: 16, right: 16, top: 16, bottom: 16 })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A1A')
  }
}