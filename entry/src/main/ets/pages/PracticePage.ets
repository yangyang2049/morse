import { PracticeViewModel } from '../viewmodel/PracticeViewModel'
import { MorseCode } from '../models/MorseCode'
import { router } from '@kit.ArkUI'
import { promptAction } from '@kit.ArkUI'
import { PracticeRecordDialog } from '../widgets/PracticeRecordDialog'

@Entry
@Component
export struct PracticePage {
  @State vm: PracticeViewModel = new PracticeViewModel()
  @State circleScale: number = 1.0 // æ§åˆ¶åœ†åœˆå’Œå­—ç¬¦çš„ç¼©æ”¾åŠ¨ç”»
  @State displayCharacter: string = '' // ç”¨äºæ˜¾ç¤ºçš„å­—ç¬¦ï¼Œæ§åˆ¶åŠ¨ç”»æ—¶åº
  private dialogController: CustomDialogController = new CustomDialogController({
    builder: PracticeRecordDialog({
      vm: $vm
    }),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: false
  })
  private difficulty: string = 'ç®€å•'
  private lastCharacterChangeId: number = -1
  private animationTimer: number | null = null

  aboutToAppear(): void {
    // ä»è·¯ç”±å‚æ•°è·å–éš¾åº¦ï¼ˆå®¹é”™å¤„ç†ï¼Œé¿å…æ— å‚æ•°æ—¶å´©æºƒï¼‰
    try {
      const params = (router.getParams?.() as Record<string, Object>) ?? {}
      const diff = params['difficulty'] as string
      this.difficulty = diff && typeof diff === 'string' ? diff : 'ç®€å•'
    } catch {
      this.difficulty = 'ç®€å•'
    }
    console.error(`[PracticePage] aboutToAppear: difficulty=${this.difficulty}`)
    this.vm.init(this.difficulty)
    this.displayCharacter = this.vm.getCurrentCharacter() // åˆå§‹åŒ–æ˜¾ç¤ºå­—ç¬¦
    this.lastCharacterChangeId = this.vm.getCharacterChangeId()
    this.startAnimationCheck()
  }

  aboutToDisappear(): void {
    this.vm.destroy()
    if (this.animationTimer) {
      clearInterval(this.animationTimer)
    }
  }

  // å¼€å§‹æ£€æŸ¥å­—ç¬¦å˜åŒ–çš„å®šæ—¶å™¨
  private startAnimationCheck(): void {
    this.animationTimer = setInterval(() => {
      const currentChangeId = this.vm.getCharacterChangeId()
      if (currentChangeId !== this.lastCharacterChangeId) {
        this.lastCharacterChangeId = currentChangeId
        
        // å…ˆéšè—å½“å‰å­—æ¯ï¼ˆä¿æŒæ—§å­—ç¬¦å†…å®¹ï¼‰
        animateTo({
          duration: 150,
          curve: Curve.EaseIn
        }, () => {
          this.circleScale = 0.0
        })
        
        // ç­‰å¾…éšè—åŠ¨ç”»å®Œæˆåæ›´æ–°å­—ç¬¦å†…å®¹å¹¶æ˜¾ç¤ºæ–°å­—æ¯
        setTimeout(() => {
          this.displayCharacter = this.vm.getCurrentCharacter() // æ›´æ–°æ˜¾ç¤ºå­—ç¬¦
          
          // å†ç­‰50msåå¼€å§‹æ˜¾ç¤ºæ–°å­—æ¯çš„åŠ¨ç”»
          setTimeout(() => {
            animateTo({
              duration: 300,
              curve: Curve.EaseInOut
            }, () => {
              this.circleScale = 1.0
            })
          }, 50)
        }, 150) // ç­‰å¾…éšè—åŠ¨ç”»å®Œæˆ
      }
    }, 100) // æ¯100msæ£€æŸ¥ä¸€æ¬¡
  }



  @Builder
  private TitleBar() {
    Row() {
      Button() {
        Text('â†')
          .fontSize(24)
          .fontColor(Color.White)
      }
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back()
      })

      Text('ç»ƒä¹ ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Button() {
        Text('ğŸ“‹')
          .fontSize(18)
          .fontColor(Color.White)
      }
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.dialogController.open()
      })
    }
    .height(52)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  private ProgressCircle() {
    // ä½¿ç”¨å­—ç¬¦ä½œä¸ºå”¯ä¸€keyï¼Œç¡®ä¿æ¯æ¬¡å­—ç¬¦å˜åŒ–æ—¶è§¦å‘åŠ¨ç”»
    Stack({ alignContent: Alignment.Center }) {
      // è¿›åº¦åœ†ç¯ï¼šåªæœ‰åœ¨ç”¨æˆ·å‡ºç°é”™è¯¯åæ‰æ˜¾ç¤º
      if (this.vm.getHasIncorrectAttempt()) {
        // èƒŒæ™¯åœˆï¼ˆæš—è‰²ï¼‰
        Circle({ width: 200, height: 200 })
          .fill(Color.Transparent)
          .strokeWidth(8)
          .stroke('#333333')

        // è¿›åº¦å¼§ - ä»é¡¶éƒ¨ä¸­å¿ƒå¼€å§‹ï¼ˆ12ç‚¹æ–¹å‘ï¼‰
        Circle({ width: 200, height: 200 })
          .fill(Color.Transparent)
          .strokeWidth(8)
          .stroke(this.vm.getProgress() >= 1.0 ? Color.Green : '#FFD700')
          .strokeDashArray([this.getRingLength(), this.getCircumference()])
          .strokeDashOffset(this.getCircumference() * 0.75) // ä»é¡¶éƒ¨12ç‚¹æ–¹å‘å¼€å§‹
          .strokeLineCap(LineCapStyle.Round)
          .animation({
            duration: 800, // æ›´é•¿çš„åŠ¨ç”»æ—¶é—´
            curve: Curve.EaseOut // æ›´å¹³æ»‘çš„æ›²çº¿
          })
      }

      // å†…å±‚åœ†åœˆï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰- æ·»åŠ é¢œè‰²è¿‡æ¸¡åŠ¨ç”»
      Column()
        .width(180)
        .height(180)
        .backgroundColor(
          this.vm.getShowResult() && !this.vm.getIsCorrect() ? Color.Red : 
          (this.vm.getIsCorrect() ? Color.Green : '#FFD700')
        )
        .borderRadius(90)
        .animation({ duration: 300, curve: Curve.EaseInOut })

      // ä¸»å­—ç¬¦ - ä½¿ç”¨displayCharacteræ§åˆ¶æ˜¾ç¤ºæ—¶åº
      Text(this.displayCharacter)
        .fontSize(72)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
    }
    .width(200)
    .height(200)
    .key(`character_${this.displayCharacter}_${this.vm.getCharacterChangeId()}`) // å”¯ä¸€keyç¡®ä¿åŠ¨ç”»è§¦å‘
    .scale({ x: this.circleScale, y: this.circleScale }) // ä½¿ç”¨çŠ¶æ€æ§åˆ¶çš„ç¼©æ”¾
  }

  private getCircumference(): number {
    // ç›´å¾„200ï¼Œæè¾¹åŠå¾„è¿‘ä¼¼ 90ï¼ˆæ‰£é™¤æè¾¹å®½åº¦çš„ä¸€åŠï¼‰ï¼›å¯¹è§†è§‰è¯¯å·®ä¸æ•æ„Ÿï¼Œç›´æ¥æŒ‰100åŠå¾„è®¡ç®—å³å¯
    return 2 * Math.PI * 100
  }

  private getRingLength(): number {
    const progress = Math.max(0, Math.min(this.vm.getProgress(), 1))
    return this.getCircumference() * progress
  }

  @Builder
  private InputDisplay() {
    Stack({ alignContent: Alignment.Center }) {
      // å ä½æ–‡æœ¬ï¼ˆå§‹ç»ˆå­˜åœ¨ä½†é€æ˜ï¼‰
      Text('- - -')
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Transparent)
        .fontFamily('monospace')
        .letterSpacing(4)

      // ä¸»è¦è¾“å…¥æ–‡æœ¬
      Text(
        this.vm.getShowHint() || this.vm.getShowCorrectAnswer() ?
        this.vm.getCurrentMorse().split('.').join('Â·') :
        this.vm.getUserInput().split('.').join('Â·')
      )
        .fontSize(36)
        .fontWeight(FontWeight.Bold)
        .fontFamily('monospace')
        .letterSpacing(4)
        .fontColor(
          this.vm.getShowCorrectAnswer() ? Color.Green :
          (this.vm.getShowHint() ? Color.White :
          (this.vm.getShowResult() && this.vm.getIsCorrect() ? Color.Green :
          (this.vm.getShowResult() && !this.vm.getIsCorrect() ? Color.Red :
          (this.vm.getUserInput().length === 0 ? Color.Transparent : '#FFD700'))))
        )
    }
    .width('100%')
    .height(60)
  }

  @Builder
  private ToolButtons() {
    Row() {
      // æ”¶è—æŒ‰é’®
      Button(this.vm.getIsFavorite() ? 'â¤' : 'â™¡')
        .onClick(() => this.vm.toggleFavorite())
        .fontColor(this.vm.getIsFavorite() ? Color.Red : Color.White)
        .width(48).height(48)
        .backgroundColor(Color.Transparent)

      // æç¤ºæŒ‰é’®ï¼ˆçœ¼ç›ï¼‰
      Button('ğŸ‘')
        .onClick(() => this.vm.flashHint())
        .fontColor(Color.White)
        .width(48).height(48)
        .backgroundColor(Color.Transparent)

      // ä¸‹ä¸€ä¸ªæŒ‰é’®
      Button('â­')
        .onClick(() => this.vm.passCharacter())
        .fontColor(Color.White)
        .width(48).height(48)
        .backgroundColor(Color.Transparent)
    }
    .justifyContent(FlexAlign.SpaceEvenly)
    .padding({ left: 20, right: 20 })
  }

  @Builder
  private BottomKeys() {
    Row() {
      // ç‚¹ (çŸ­éŸ³)
      Button() {
        Circle({ width: 20, height: 20 })
          .fill('#FFD700')
      }
      .height(80)
      .backgroundColor('#1A1A1A')
      .borderRadius(20)
      .border({ width: 1, color: '#333333' })
      .onClick(() => this.vm.addDot())
      .layoutWeight(1)

      Blank().width(20)

      // åˆ’ (é•¿éŸ³)
      Button() {
        Rect({ width: 40, height: 12 })
          .fill('#FFD700')
      }
      .height(80)
      .backgroundColor('#1A1A1A')
      .borderRadius(20)
      .border({ width: 1, color: '#333333' })
      .onClick(() => this.vm.addDash())
      .layoutWeight(1)
    }
    .padding({ left: 20, right: 20, bottom: 20 })
  }



  build() {
    Stack() {
      Column() {
        this.TitleBar()

        Blank().height(20)

        // ä¸»è¦å†…å®¹
        Column() {
          // å­—ç¬¦ä¸è¿›åº¦åœ†åœˆ
          this.ProgressCircle()

          Blank().height(40)

          this.InputDisplay()
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)

        this.ToolButtons()
        Blank().height(26)
        this.BottomKeys()
      }
      .width('100%')
      .height('100%')
      .backgroundColor(Color.Black)
    }
  }
}
