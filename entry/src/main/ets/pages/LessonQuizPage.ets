import { router } from '@kit.ArkUI'
import preferences from '@ohos.data.preferences'
import window from '@ohos.window'
import { ExplanationTipsCard } from '../widgets/ExplanationTipsCard'
import { LearnViewModel } from '../viewmodel/LearnViewModel'

interface QuizNavParams {
  testType?: string
  pageTitle?: string
  testCompletedKey?: string
}

interface QuestionItem {
  type: string
  question: string
  answer: boolean | number
  points: number
  options?: string[]
}

interface ExplanationItem {
  title: string
  content: string
}

interface ButtonStyle {
  backgroundColor: string
  textColor: string
  borderColor: string
}

@Entry
@Component
struct LessonQuizPage {
  @State testType: string = 'intro'
  @State pageTitle: string = 'åŸºç¡€æµ‹è¯•'
  @State testCompletedKey: string = 'intro_test_completed'
  @State learnViewModel: LearnViewModel = new LearnViewModel()
  @State currentQuestionIndex: number = 0
  @State score: number = 0
  @State isAnswered: boolean = false
  @State selectedAnswer: number | null = null
  @State showResult: boolean = false
  @State showExplanation: boolean = false
  @State showDelayedContent: boolean = false
  @State showNextButton: boolean = false
  @State progressSaved: boolean = false

  @State questions: QuestionItem[] = []
  @State explanations: ExplanationItem[] = []

  aboutToAppear() {
    // Set status bar color
    const uiContext = this.getUIContext()
    const hostContext = uiContext.getHostContext()
    if (hostContext) {
      window.getLastWindow(hostContext).then((windowClass) => {
        windowClass.setWindowSystemBarProperties({
          statusBarColor: '#000000',
          statusBarContentColor: '#FFFFFF'
        })
      })
    }

    // Load route params, if any
    try {
      const params = (router.getParams?.() as QuizNavParams) ?? {}
      if (params) {
        if (params.testType) this.testType = params.testType
        if (params.pageTitle) this.pageTitle = params.pageTitle
        if (params.testCompletedKey) this.testCompletedKey = params.testCompletedKey
      }
      console.error(`[QUIZ] aboutToAppear params: testType=${this.testType}, pageTitle=${this.pageTitle}, testCompletedKey=${this.testCompletedKey}`)
    } catch (e) {
      console.warn('No params or failed to read params for LessonQuizPage:', e)
    }

    // Initialize ViewModel and questions for selected test type
    const uiContext2 = this.getUIContext()
    const hostContext2 = uiContext2.getHostContext()
    if (hostContext2) {
      this.learnViewModel.init(hostContext2)
    }
    console.error('[QUIZ] aboutToAppear: init ViewModel called')
    this.initializeTestData()
  }

  initializeTestData() {
    console.error(`[QUIZ] initializeTestData: testType=${this.testType}`)
    if (this.testType === 'intro') {
      this.questions = [
        {
          type: 'true_false',
          question: 'æ‘©æ–¯å¯†ç æ˜¯ä»¥"ç‚¹ï¼ˆÂ·ï¼‰å’Œåˆ’ï¼ˆ-ï¼‰"ä¸ºåŸºæœ¬å…ƒç´ çš„å­—ç¬¦ç¼–ç ç³»ç»Ÿã€‚',
          answer: true,
          points: 20,
        },
        {
          type: 'true_false',
          question: 'SOSä¿¡å·çš„æ‘©æ–¯å¯†ç æ˜¯ Â·Â·Â· --- Â·Â·Â·ï¼Œå„å­—ç¬¦ä¹‹é—´éœ€è¦ä¿æŒæ­£å¸¸çš„å­—ç¬¦é—´éš”ã€‚',
          answer: false, // SOSæ˜¯ç´§å‡‘å‘é€ï¼Œæ— å­—ç¬¦é—´éš”
          points: 20,
        },
        {
          type: 'multiple_choice',
          question: 'æ‘©æ–¯å¯†ç çš„æ—¶åºè§„åˆ™ä¸­ï¼Œç‚¹ã€åˆ’ã€å­—ç¬¦é—´éš”çš„å•ä½æ¯”ä¾‹æ˜¯ï¼š',
          options: ['1 : 2 : 5', '1 : 3 : 7', '1 : 4 : 8', '2 : 3 : 6'],
          answer: 1, // 1:3:7
          points: 20,
        },
        {
          type: 'multiple_choice',
          question: 'æ‘©æ–¯å¯†ç æ˜¯åœ¨å“ªä¸ªå¹´ä»£å¼€å‘çš„ï¼Ÿ',
          options: ['1820 å¹´ä»£', '1830-1840 å¹´ä»£', '1850 å¹´ä»£', '1860 å¹´ä»£'],
          answer: 1, // 1830-1840å¹´ä»£
          points: 20,
        },
        {
          type: 'multiple_choice',
          question: 'å­¦ä¹ æ‘©æ–¯å¯†ç çš„å»ºè®®é¡ºåºæ˜¯ï¼š',
          options: ['æ•°å­— â†’ å­—æ¯ â†’ ç¬¦å·', 'ç¬¦å· â†’ å­—æ¯ â†’ æ•°å­—', 'å­—æ¯ â†’ æ•°å­— â†’ ç¬¦å·', 'éšæœºå­¦ä¹ '],
          answer: 2, // å­—æ¯â†’æ•°å­—â†’ç¬¦å·
          points: 20,
        },
      ]

      this.explanations = [
        {
          title: 'æ‘©æ–¯å¯†ç åŸºæœ¬å…ƒç´ ',
          content: 'â€¢ æ‘©æ–¯å¯†ç ä»¥"ç‚¹ï¼ˆÂ·ï¼‰å’Œåˆ’ï¼ˆ-ï¼‰"ä¸ºåŸºæœ¬å…ƒç´ \nâ€¢ é€šè¿‡ä¸åŒçš„ç‚¹åˆ’ç»„åˆè¡¨ç¤ºå­—æ¯ã€æ•°å­—å’Œç¬¦å·\nâ€¢ è¿™æ˜¯æ‰€æœ‰æ‘©æ–¯å¯†ç çš„åŸºç¡€ï¼Œå¿…é¡»ç†Ÿç»ƒæŽŒæ¡',
        },
        {
          title: 'SOSä¿¡å·çš„ç‰¹æ®Šæ€§',
          content: 'â€¢ SOSæ˜¯ç´§æ€¥æ±‚æ•‘ä¿¡å·ï¼Œéœ€è¦å¿«é€Ÿè¯†åˆ«\nâ€¢ ç´§å‡‘å‘é€ï¼šä¸‰ä¸ªå­—ç¬¦ï¼ˆÂ·Â·Â· --- Â·Â·Â·ï¼‰æ˜¯ç´§å‡‘å‘é€çš„ï¼Œæ²¡æœ‰æ­£å¸¸çš„å­—ç¬¦é—´éš”\nâ€¢ æ ‡å‡†é—´éš”è§„åˆ™ï¼šæ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‘©æ–¯å¯†ç å­—ç¬¦ä¹‹é—´åº”è¯¥æœ‰3ä¸ªå•ä½çš„é—´éš”\nâ€¢ SOSä¾‹å¤–ï¼šä½†SOSä½œä¸ºç´§æ€¥ä¿¡å·ï¼Œä¼šå¿½ç•¥è¿™ä¸ªè§„åˆ™ï¼Œç´§å‡‘å‘é€ä»¥æé«˜è¯†åˆ«é€Ÿåº¦',
        },
        {
          title: 'æ—¶åºè§„åˆ™çš„é‡è¦æ€§',
          content: 'â€¢ 1:3:7æ¯”ä¾‹æ˜¯æ‘©æ–¯å¯†ç çš„æ ¸å¿ƒè§„åˆ™\nâ€¢ ç‚¹=1å•ä½ï¼Œåˆ’=3å•ä½ï¼Œå­—ç¬¦é—´éš”=3å•ä½ï¼Œå•è¯é—´éš”=7å•ä½\nâ€¢ è¿™ä¸ªç²¾ç¡®çš„æ—¶åºç¡®ä¿äº†ä¿¡æ¯ä¼ è¾“çš„å‡†ç¡®æ€§å’Œå¯è¯»æ€§',
        },
        {
          title: 'åŽ†å²èƒŒæ™¯',
          content: 'â€¢ å¡žç¼ªå°”Â·æ‘©æ–¯ä¸Žé˜¿å°”å¼—é›·å¾·Â·éŸ¦å°”åœ¨1830-1840å¹´ä»£åˆä½œå¼€å‘\nâ€¢ æœ€åˆç”¨äºŽç”µæŠ¥ç³»ç»Ÿï¼ŒåŽæ¥æ¼”åŒ–ä¸ºå›½é™…æ‘©æ–¯å¯†ç \nâ€¢ æˆä¸ºå…¨çƒæ ‡å‡†çš„æ— çº¿ç”µé€šä¿¡ç¼–ç ç³»ç»Ÿ',
        },
        {
          title: 'å­¦ä¹ ç­–ç•¥',
          content: 'â€¢ å­—æ¯ â†’ æ•°å­— â†’ ç¬¦å·çš„å­¦ä¹ é¡ºåºæœ€ç§‘å­¦\nâ€¢ å…ˆæŽŒæ¡åŸºç¡€å­—æ¯ï¼Œå†å­¦ä¹ æ•°å­—å’Œç¬¦å·\nâ€¢ å¾ªåºæ¸è¿›ï¼Œé¿å…ä¿¡æ¯è¿‡è½½ï¼Œæé«˜å­¦ä¹ æ•ˆçŽ‡',
        },
      ]
    } else {
      // chinese
      this.questions = [
        {
          type: 'true_false',
          question: 'ä¸­æ–‡æ‘©å°”æ–¯ç”µç æ˜¯ä¸“é—¨ä¸ºä¸­æ–‡æ±‰å­—è®¾è®¡çš„æ‘©å°”æ–¯ç”µç ç³»ç»Ÿã€‚',
          answer: true,
          points: 20,
        },
        {
          type: 'true_false',
          question: 'ä¸­æ–‡æ‘©å°”æ–¯ç”µç çš„ç¼–ç é•¿åº¦é€šå¸¸æ¯”è‹±æ–‡æ‘©å°”æ–¯ç”µç çŸ­ã€‚',
          answer: false, // ä¸­æ–‡ç¼–ç é€šå¸¸æ›´é•¿
          points: 20,
        },
        {
          type: 'multiple_choice',
          question: 'ä¸­æ–‡æ‘©å°”æ–¯ç”µç æ˜¯åœ¨å“ªä¸ªå¹´ä»£å¼€å§‹åˆ¶å®šçš„ï¼Ÿ',
          options: ['1900å¹´ä»£', '1920å¹´ä»£', '1950å¹´ä»£', '1980å¹´ä»£'],
          answer: 1, // 1920å¹´ä»£
          points: 20,
        },
        {
          type: 'multiple_choice',
          question: 'ä»¥ä¸‹å“ªä¸ªä¸æ˜¯ä¸­æ–‡æ‘©å°”æ–¯ç”µç çš„åº”ç”¨åœºæ™¯ï¼Ÿ',
          options: ['å†›äº‹é€šä¿¡', 'èˆªç©ºé€šä¿¡', 'ç½‘ç»œèŠå¤©', 'èˆªæµ·é€šä¿¡'],
          answer: 2, // ç½‘ç»œèŠå¤©
          points: 20,
        },
        {
          type: 'multiple_choice',
          question: 'å­¦ä¹ ä¸­æ–‡æ‘©å°”æ–¯ç”µç çš„å»ºè®®é¡ºåºæ˜¯ï¼š',
          options: ['ä»Žå¤æ‚æ±‰å­—å¼€å§‹', 'ä»ŽåŸºç¡€æ±‰å­—å¼€å§‹', 'éšæœºå­¦ä¹ ', 'ä»Žæ ‡ç‚¹ç¬¦å·å¼€å§‹'],
          answer: 1, // ä»ŽåŸºç¡€æ±‰å­—å¼€å§‹
          points: 20,
        },
      ]

      this.explanations = [
        {
          title: 'ä¸­æ–‡æ‘©å°”æ–¯ç”µç çš„å®šä¹‰',
          content: 'â€¢ ä¸­æ–‡æ‘©å°”æ–¯ç”µç æ˜¯ä¸“é—¨ä¸ºä¸­æ–‡æ±‰å­—è®¾è®¡çš„ç¼–ç ç³»ç»Ÿ\nâ€¢ é€šè¿‡ç‚¹ï¼ˆÂ·ï¼‰å’Œåˆ’ï¼ˆ-ï¼‰çš„ç»„åˆè¡¨ç¤ºä¸­æ–‡å­—ç¬¦\nâ€¢ ç»“åˆäº†ä¼ ç»Ÿæ‘©å°”æ–¯ç”µç åŽŸç†å’Œä¸­æ–‡è¯­è¨€ç‰¹ç‚¹\nâ€¢ ä¸ºä¸­æ–‡é€šä¿¡æä¾›äº†æ ‡å‡†åŒ–çš„ç¼–ç æ–¹æ¡ˆ',
        },
        {
          title: 'ç¼–ç é•¿åº¦çš„ç‰¹ç‚¹',
          content: 'â€¢ ä¸­æ–‡æ‘©å°”æ–¯ç”µç çš„ç¼–ç é€šå¸¸æ¯”è‹±æ–‡æ›´é•¿\nâ€¢ è¿™æ˜¯å› ä¸ºä¸­æ–‡å­—ç¬¦æ•°é‡åºžå¤§ï¼Œéœ€è¦æ›´å¤šç‚¹åˆ’ç»„åˆ\nâ€¢ æ¯ä¸ªæ±‰å­—éƒ½æœ‰å”¯ä¸€çš„æ‘©å°”æ–¯ç”µç è¡¨ç¤º\nâ€¢ ç¼–ç é•¿åº¦å¢žåŠ æ˜¯ä¸ºäº†ç¡®ä¿å­—ç¬¦çš„å”¯ä¸€æ€§',
        },
        {
          title: 'åŽ†å²å‘å±•èƒŒæ™¯',
          content: 'â€¢ 1920å¹´ä»£ï¼šåˆæ­¥åˆ¶å®šä¸­æ–‡æ‘©å°”æ–¯ç”µç æ ‡å‡†\nâ€¢ å½“æ—¶ä¸ºäº†é€‚åº”ä¸­æ–‡ç”µæŠ¥é€šä¿¡çš„éœ€æ±‚\nâ€¢ å›½é™…ç”µä¿¡è”ç›Ÿï¼ˆITUï¼‰å‚ä¸Žåˆ¶å®š\nâ€¢ ç»è¿‡å¤šæ¬¡ä¼˜åŒ–å½¢æˆçŽ°ä»£æ ‡å‡†',
        },
        {
          title: 'åº”ç”¨åœºæ™¯åˆ†æž',
          content: 'â€¢ å†›äº‹é€šä¿¡ï¼šéƒ¨é˜Ÿé—´çš„ç§˜å¯†é€šä¿¡\nâ€¢ èˆªç©ºé€šä¿¡ï¼šé£žè¡Œå‘˜ä¸Žåœ°é¢æŽ§åˆ¶å¡”é€šä¿¡\nâ€¢ èˆªæµ·é€šä¿¡ï¼šèˆ¹èˆ¶é—´é€šä¿¡\nâ€¢ ç½‘ç»œèŠå¤©ä¸å±žäºŽä¼ ç»Ÿåº”ç”¨åœºæ™¯',
        },
        {
          title: 'å­¦ä¹ ç­–ç•¥å»ºè®®',
          content: 'â€¢ ä»ŽåŸºç¡€æ±‰å­—å¼€å§‹å­¦ä¹ æœ€ç§‘å­¦\nâ€¢ åŸºç¡€æ±‰å­—ä½¿ç”¨é¢‘çŽ‡é«˜ï¼Œå®¹æ˜“è®°å¿†\nâ€¢ å¾ªåºæ¸è¿›ï¼Œé¿å…ä¿¡æ¯è¿‡è½½\nâ€¢ å»ºç«‹å­¦ä¹ ä¿¡å¿ƒï¼Œæé«˜å­¦ä¹ æ•ˆçŽ‡',
        },
      ]
    }
  }

  selectAnswer(answer: boolean | number) {
    if (this.isAnswered) return

    this.selectedAnswer = answer === true ? 1 : (answer === false ? 0 : answer as number)
    this.isAnswered = true

    // Check answer
    let isCorrect = false
    if (this.questions[this.currentQuestionIndex].type === 'true_false') {
      const correctAnswer = this.questions[this.currentQuestionIndex].answer as boolean
      isCorrect = (answer === correctAnswer)
    } else {
      const correctAnswer = this.questions[this.currentQuestionIndex].answer as number
      isCorrect = (answer === correctAnswer)
    }

    if (isCorrect) {
      this.score += this.questions[this.currentQuestionIndex].points
    }
    console.error(`[QUIZ] selectAnswer: qIdx=${this.currentQuestionIndex} type=${this.questions[this.currentQuestionIndex].type} selected=${this.selectedAnswer} correct=${isCorrect} score=${this.score}`)

    // Show explanation immediately, but delay opacity animation for content
    this.showExplanation = true
    // Delay the opacity animation for 300ms
    setTimeout(() => {
      this.showDelayedContent = true
    }, 300)
    // Delay the next button for additional 600ms (total 1200ms)
    setTimeout(() => {
      this.showNextButton = true
    }, 900)
  }

  showTestResult() {
    this.showResult = true

    const willSave = this.score >= 100
    console.error(`[QUIZ] showTestResult: score=${this.score} willPersist=${willSave}`)
    if (willSave) {
      this.markLessonCompleted()
    }
  }

  async markLessonCompleted() {
    try {
      // ä½¿ç”¨ ViewModel æ¥æ ‡è®°æµ‹è¯•å®Œæˆï¼Œè¿™ä¼šè‡ªåŠ¨è§£é”ä¸‹ä¸€è¯¾
      const uiContext = this.getUIContext()
      const hostContext = uiContext.getHostContext()
      if (hostContext) { //change the key plz
        await this.learnViewModel.markLessonCompleted(this.testCompletedKey, hostContext)
      }
      
      this.progressSaved = true
    } catch (err) {
    }
  }

  restartTest() {
    this.currentQuestionIndex = 0
    this.score = 0
    this.isAnswered = false
    this.selectedAnswer = null
    this.showResult = false
    this.showExplanation = false
    this.showDelayedContent = false
    this.showNextButton = false
  }

  async goToNextLesson() {
    console.error(`[QUIZ] goToNextLesson: score=${this.score} progressSaved=${this.progressSaved}`)
    // Ensure progress is persisted before leaving so Learn tab sees the unlocks
    if (this.score >= 100 && !this.progressSaved) {
      console.error('[QUIZ] goToNextLesson: awaiting persist...')
      await this.markLessonCompleted()
    }
    // å¼¹å‡ºä¸¤æ¬¡è¿”å›žåˆ°å­¦ä¹ é¡µé¢
    console.error('[QUIZ] goToNextLesson: navigating back twice')
    router.back()
    router.back()
  }

  async backAfterPersist() {
    console.error(`[QUIZ] backAfterPersist: score=${this.score} progressSaved=${this.progressSaved}`)
    if (this.score >= 100 && !this.progressSaved) {
      console.error('[QUIZ] backAfterPersist: awaiting persist...')
      await this.markLessonCompleted()
    }
    console.error('[QUIZ] backAfterPersist: navigating back once')
    router.back()
  }

  @Builder
  TitleBar() {
    Row() {
      Button() {
        Image($rawfile('ic_back.svg'))
          .width(24)
          .height(24)
          .fillColor(Color.White)
      }
      .width(48)
      .height(48)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back()
      })

      Text(this.pageTitle)
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      Text(`${this.currentQuestionIndex + 1}/${this.questions.length}`)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .margin({ right: 16 })
    }
    .height(52)
    .padding({ left: 16, right: 16 })
    .backgroundColor(Color.Transparent)
  }

  @Builder
  ResultScreen() {
    Column() {
      Text(this.score >= 100 ? 'ðŸ‘' : 'ðŸ˜¢')
        .fontSize(80)
        .margin({ bottom: 16 })

      Text('ä½ çš„åˆ†æ•°')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFFB3')
        .margin({ bottom: 4 })

      Text(`${this.score}`)
        .fontSize(128)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.score >= 100 ? '#4CAF50' : '#FF8C00')
        .margin({ bottom: 8 })

      Column() {
        Text(this.score >= 100 ? 'ðŸŽ‰ æ­å–œé€šè¿‡ï¼' : 'ç»§ç»­åŠªåŠ›ï¼')
          .fontSize(28)
          .fontColor(Color.White)
          .textAlign(TextAlign.Center)
          .margin({ bottom: 8 })

        if (this.score >= 100) {
          Text('ä½ å·²ç»æŽŒæ¡äº†æ‘©æ–¯å¯†ç çš„åŸºç¡€çŸ¥è¯†')
            .fontSize(16)
            .fontColor(Color.White)
            .textAlign(TextAlign.Center)
            .margin({ bottom: 8 })
        } else {
          Text('éœ€è¦100åˆ†æ‰èƒ½é€šè¿‡æµ‹è¯•')
            .fontSize(16)
            .fontColor('#FFFFFFB3')
            .fontWeight(FontWeight.Medium)
            .textAlign(TextAlign.Center)
        }
      }
      .margin({ bottom: 48 })

      Row() {
        Button() {
          Row() {
            Image($rawfile('ic_back.svg')).width(16).height(16).fillColor('#1A1A1A').margin({ right: 8 })
            Text('è¿”å›ž')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')
          }
        }
        .layoutWeight(1)
        .height(48)
        .backgroundColor(Color.White)
        .borderRadius(8)
        .onClick(() => {
          this.backAfterPersist()
        })

        if (this.score >= 100) {
          Button() {
            Row() {
              Text('ä¸‹ä¸€è¯¾')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1A1A1A')
              Image($rawfile('ic_forward.svg')).width(16).height(16).fillColor('#1A1A1A').margin({ left: 8 })
            }
          }
          .layoutWeight(1)
          .height(48)
          .backgroundColor('#FFD700')
          .borderRadius(8)
          .margin({ left: 16 })
          .onClick(() => {
            this.goToNextLesson()
          })
        } else {
          Button() {
            Row() {
              Text('é‡æ–°æµ‹è¯•')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor(Color.White)
              Image($rawfile('ic_forward.svg')).width(16).height(16).fillColor(Color.White).margin({ left: 8 })
            }
          }
          .layoutWeight(1)
          .height(48)
          .backgroundColor('#FF8C00')
          .borderRadius(8)
          .margin({ left: 16 })
          .onClick(() => {
            this.restartTest()
          })
        }
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .padding(24)
  }

  @Builder
  QuestionScreen() {

    Column() {
      // Top spacing - å½“å·²å›žç­”æ—¶å‡å°‘é—´è·
      Blank()
        .layoutWeight(this.isAnswered ? 0.5 : 1)

      // Main content area
      Column() {
        // Question card
        Column() {
          Text(this.questions[this.currentQuestionIndex].question)
            .fontSize(18)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
            .lineHeight(27)
            .textAlign(TextAlign.Center)
            .width('100%')
        }
        .width('100%')
        .height(160)
        .padding({ left: 16, right: 16, top: 24, bottom: 24 })
        .backgroundColor('#FFF8DC')
        .borderRadius(16)
        .margin({ bottom: 32 })
        .justifyContent(FlexAlign.Center)
        .animation({
          duration: 600,
          curve: Curve.EaseInOut
        })

        // Answer options
        if (this.questions[this.currentQuestionIndex].type === 'true_false') {
          this.buildTrueFalseOptions()
        } else {
          this.buildMultipleChoiceOptions()
        }

        // Explanation card - ç«‹å³æ˜¾ç¤ºï¼Œä½¿ç”¨é€æ˜Žåº¦åŠ¨ç”»
        if (this.isAnswered && this.showExplanation) {
          ExplanationTipsCard({
            title: this.explanations[this.currentQuestionIndex].title,
            content: this.explanations[this.currentQuestionIndex].content,
            color: '#FF8C00'
          })
          .margin({ top: 24 })
          .opacity(this.showDelayedContent ? 1 : 0)
          .animation({
            duration: 600,
            curve: Curve.EaseInOut
          })
        }

        // Next button - å»¶è¿Ÿæ˜¾ç¤ºï¼Œä½¿ç”¨é€æ˜Žåº¦åŠ¨ç”»
        if (this.isAnswered) {
          Column() {
            this.NextButton()
          }
          .margin({ top: 24 })
          .opacity(this.showNextButton ? 1 : 0)
          .animation({
            duration: 600,
            curve: Curve.EaseInOut
          })
        }
      }

      // Bottom spacing - å½“å·²å›žç­”æ—¶å‡å°‘é—´è·
      Blank()
        .layoutWeight(this.isAnswered ? 0.5 : 1)
    }
    .width('100%')
    .height('100%')
    .padding(24)
    .animation({
      duration: 600,
      curve: Curve.EaseInOut
    })
  }

  @Builder
  buildTrueFalseOptions() {
    Column() {
      this.buildTFAnswerButton('æ­£ç¡®', true, this.selectedAnswer === 1)

      Column() {
        this.buildTFAnswerButton('é”™è¯¯', false, this.selectedAnswer === 0)
      }
      .margin({ top: 16 })
    }
  }

  getTFButtonStyle(choiceValue: boolean, isSelected: boolean): ButtonStyle {
    if (this.isAnswered) {
      const correct = this.questions[this.currentQuestionIndex].answer as boolean
      if (choiceValue === correct) {
        return { backgroundColor: '#E8F5E8', textColor: '#2E7D32', borderColor: '#4CAF50' }
      }
      if (isSelected) {
        return { backgroundColor: '#FFEBEE', textColor: '#C62828', borderColor: '#F44336' }
      }
      return { backgroundColor: '#F5F5F5', textColor: '#9E9E9E', borderColor: '#E0E0E0' }
    }
    if (isSelected) {
      return { backgroundColor: '#E3F2FD', textColor: '#1A1A1A', borderColor: '#2196F3' }
    }
    return { backgroundColor: '#F5F5F5', textColor: '#1A1A1A', borderColor: '#E0E0E0' }
  }

  @Builder
  buildTFAnswerButton(text: string, value: boolean, isSelected: boolean) {
    Button() {
      Text(text)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getTFButtonStyle(value, isSelected).textColor)
        .width('100%')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(48)
    .backgroundColor(this.getTFButtonStyle(value, isSelected).backgroundColor)
    .border({ width: 2, color: this.getTFButtonStyle(value, isSelected).borderColor })
    .borderRadius(12)
    .onClick(() => {
      this.selectAnswer(value)
    })
  }

  @Builder
  buildMultipleChoiceOptions() {
    Column() {
      ForEach(this.questions[this.currentQuestionIndex].options || [], (option: string, index: number) => {
        // å¦‚æžœå·²å›žç­”ï¼Œåªæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆå’Œç”¨æˆ·é€‰æ‹©çš„é”™è¯¯ç­”æ¡ˆ
        if (this.isAnswered) {
          // åªæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆæˆ–ç”¨æˆ·é€‰æ‹©çš„é”™è¯¯ç­”æ¡ˆ
          if (this.questions[this.currentQuestionIndex].answer === index || this.selectedAnswer === index) {
            Column() {
              this.buildAnswerButton(
                option,
                index,
                this.selectedAnswer === index,
                this.isAnswered && this.questions[this.currentQuestionIndex].answer === index,
                this.isAnswered && this.selectedAnswer === index && this.questions[this.currentQuestionIndex].answer !== index,
                false
              )
            }
            .margin({ top: 16 })
          }
        } else {
          // æœªå›žç­”æ—¶æ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
          Column() {
            this.buildAnswerButton(
              option,
              index,
              this.selectedAnswer === index,
              this.isAnswered && this.questions[this.currentQuestionIndex].answer === index,
              this.isAnswered && this.selectedAnswer === index && this.questions[this.currentQuestionIndex].answer !== index,
              false
            )
          }
          .margin({ top: index > 0 ? 16 : 0 })
        }
      }, (option: string, index: number) => `q${this.currentQuestionIndex}-opt${index}-${option.substring(0, 10)}`)
    }
  }

  getButtonStyle(isSelected: boolean, isCorrect: boolean, isWrong: boolean, isTrueFalse: boolean = false): ButtonStyle {
    if (this.isAnswered) {
      if (isCorrect) {
        return {
          backgroundColor: '#E8F5E8',
          textColor: '#2E7D32',
          borderColor: '#4CAF50'
        }
      } else if (isWrong) {
        return {
          backgroundColor: '#FFEBEE',
          textColor: '#C62828',
          borderColor: '#F44336'
        }
      }
      // å·²ä½œç­”ä½†æ—¢ä¸æ˜¯æ­£ç¡®ä¹Ÿä¸æ˜¯é”™è¯¯ï¼ˆå³æœªè¢«é€‰æ‹©çš„é”™è¯¯é¡¹ï¼‰æ—¶ï¼Œç»Ÿä¸€ç°æ˜¾
      return {
        backgroundColor: '#F5F5F5',
        textColor: '#9E9E9E',
        borderColor: '#E0E0E0'
      }
    } else if (isSelected) {
      return {
        backgroundColor: '#E3F2FD',
        textColor: '#1A1A1A',
        borderColor: '#2196F3'
      }
    }
    return {
      backgroundColor: '#F5F5F5',
      textColor: '#1A1A1A',
      borderColor: '#E0E0E0'
    }
  }

  @Builder
  buildAnswerButton(
    text: string,
    value: boolean | number,
    isSelected: boolean,
    isCorrect: boolean,
    isWrong: boolean,
    isTrueFalse: boolean = false
  ) {
    Button() {
      Text(text)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.getButtonStyle(isSelected, isCorrect, isWrong, isTrueFalse).textColor)
        .width('100%')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(48)
    .backgroundColor(this.getButtonStyle(isSelected, isCorrect, isWrong, isTrueFalse).backgroundColor)
    .border({ width: 2, color: this.getButtonStyle(isSelected, isCorrect, isWrong, isTrueFalse).borderColor })
    .borderRadius(12)
    .onClick(() => {
      this.selectAnswer(value)
    })
  }

  @Builder
  NextButton() {
    if (this.isAnswered) {
      Button() {
        Text(this.currentQuestionIndex < this.questions.length - 1 ? 'ä¸‹ä¸€é¢˜' : 'æŸ¥çœ‹ç»“æžœ')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
          .width('100%')
          .textAlign(TextAlign.Center)
      }
      .width('100%')
      .height(48)
      .backgroundColor('#FFD700')
      .borderRadius(12)
      .onClick(() => {
        if (this.currentQuestionIndex < this.questions.length - 1) {
          this.currentQuestionIndex++
          this.isAnswered = false
          this.selectedAnswer = null
          this.showExplanation = false
          this.showDelayedContent = false
          this.showNextButton = false
        } else {
          this.showTestResult()
        }
      })
    }
  }

  build() {
    Column() {
      this.TitleBar()

      if (this.showResult) {
        this.ResultScreen()
      } else {
        Column() {
          this.QuestionScreen()
        }
        .layoutWeight(1)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
