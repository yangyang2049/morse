import { router } from '@kit.ArkUI'
// System bar colors are set globally in EntryAbility
import util from '@ohos.util'

interface ChineseTelegraphCode {
  character: string
  code: string
}

@Entry
@Component
export struct ChineseTelegraphCodePage {
  @State codes: ChineseTelegraphCode[] = []
  @State searchText: string = ''
  @State filteredCodes: ChineseTelegraphCode[] = []
  @State isLoading: boolean = true
  private infoDialog: CustomDialogController = new CustomDialogController({
    builder: this.InfoDialog(),
    autoCancel: true,
    alignment: DialogAlignment.Center,
    customStyle: false
  })

  aboutToAppear() {
    // System bar colors are set globally in EntryAbility

    // å»¶è¿ŸåŠ è½½æ•°æ®ï¼Œè®©é¡µé¢å…ˆæ˜¾ç¤º
    setTimeout(() => {
      this.loadChineseTelegraphCodes()
    }, 100)
  }

  private loadChineseTelegraphCodes() {
    try {
      // Load from rawfile
      const uiContext = this.getUIContext()
      const hostContext = uiContext.getHostContext()
      if (hostContext) {
        hostContext.resourceManager.getRawFileContent('chinese_telegraph_codes_full.json')
        .then((data: ArrayBuffer) => {
          const decoder = new util.TextDecoder('utf-8')
          const uint8Array = new Uint8Array(data)
          const jsonString = decoder.decodeWithStream(uint8Array)
          const parsedData = JSON.parse(jsonString) as ChineseTelegraphCode[]
          this.codes = parsedData
          this.filteredCodes = parsedData
          this.isLoading = false
          console.log(`Loaded ${this.codes.length} Chinese telegraph codes`)
        })
        .catch(() => {
          console.error('Failed to load Chinese telegraph codes')
          // Fallback to empty array
          this.codes = []
          this.filteredCodes = []
          this.isLoading = false
        })
      } else {
        console.error('Host context is undefined')
        this.codes = []
        this.filteredCodes = []
        this.isLoading = false
      }
    } catch {
      console.error('Error loading Chinese telegraph codes')
      this.codes = []
      this.filteredCodes = []
      this.isLoading = false
    }
  }

  // Removed onPageShow system bar re-application to avoid flicker

  private onSearchTextChange(text: string) {
    this.searchText = text
    if (text.trim() === '') {
      this.filteredCodes = this.codes
    } else {
      this.filteredCodes = this.codes.filter(code => 
        code.character.includes(text) || code.code.includes(text)
      )
    }
  }

  @Builder
  TitleBar() {
    Row() {
      Button() {
        Image($rawfile('ic_back.svg'))
          .width(24)
          .height(24)
          .fillColor(Color.White)
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back()
      })

      Text('æ ‡å‡†ä¸­æ–‡ç”µç ')
        .fontSize(18)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // Info entrance at top-right (emoji memo)
      Button() {
        Text('ðŸ“')
          .fontSize(20)
          .fontColor(Color.White)
          .textAlign(TextAlign.Center)
          .width('100%')
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        this.infoDialog.open()
      })
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  private InfoDialog() {
    // ç®€è¦è¯´æ˜Žæ ‡å‡†ä¸­æ–‡ç”µç è¡¨
    Column() {
      Text('æ ‡å‡†ä¸­æ–‡ç”µç è¡¨è¯´æ˜Ž')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .textAlign(TextAlign.Center)

      Blank().height(12)

      Scroll() {
        Column() {
          Text('â€¢ æ ‡å‡†ä¸­æ–‡ç”µç ï¼ˆChinese Telegraph Code, CTCï¼‰æ˜¯ä¸€å¥—ç”¨å››ä½æ•°å­—è¡¨ç¤ºå¸¸ç”¨æ±‰å­—çš„ç¼–ç ä½“ç³»ï¼Œæœ€æ—©ç”¨äºŽç”µæŠ¥ä¼ è¾“ã€‚')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .textAlign(TextAlign.Start)
            .width('100%')

          Blank().height(8)

          Text('â€¢ æ¯ä¸ªæ±‰å­—å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„å››ä½æ•°å­—ï¼ˆ0001â€“9999ï¼‰ï¼Œä¾¿äºŽåœ¨é€šä¿¡ä¸­å‡†ç¡®ä¼ é€’ã€‚')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .textAlign(TextAlign.Start)
            .width('100%')

          Blank().height(8)

          Text('â€¢ æœ¬é¡µé¢å¯æŒ‰â€œæ±‰å­—â€æˆ–â€œç”µç â€æœç´¢ï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½ç›®æ ‡ã€‚')
            .fontSize(14)
            .fontColor('#CCCCCC')
            .textAlign(TextAlign.Start)
            .width('100%')
        }
        .width('100%')
      }
      .height(140)

      Blank().height(16)

      Row() {
        Button() {
          Text('çŸ¥é“äº†')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .textAlign(TextAlign.Center)
            .width('100%')
        }
        .height(44)
        .layoutWeight(1)
        .backgroundColor('#FFD700')
        .borderRadius(10)
        .onClick(() => this.infoDialog.close())
      }
      .width('100%')
    }
    .width(420)
    .padding(20)
    .backgroundColor('#000000')
    .border({ width: 1, color: '#333333' })
    .borderRadius(16)
  }

  @Builder
  SearchBar() {
    Search({
      value: this.searchText,
      placeholder: 'æœç´¢æ±‰å­—æˆ–ç”µç ...'
    })
    .placeholderColor('#666666')
    .fontColor(Color.White)
    .backgroundColor('#1A1A1A')
    .borderRadius(20)
    .height(40)
    .searchIcon({ color: Color.White })
    .onChange((value: string) => {
      this.onSearchTextChange(value)
    })
    .onSubmit((value: string) => {
      this.onSearchTextChange(value)
    })
    .width('100%')
    .margin({ left: 16, right: 16, top: 16, bottom: 8 })
  }

  @Builder
  TableHeader() {
    Row() {
      Text('æ±‰å­—')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFD700')
        .width('25%')
        .textAlign(TextAlign.Center)

      Text('ç”µç ')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFD700')
        .width('75%')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(48)
    .backgroundColor('#1A1A1A')
    .padding({ left: 16, right: 16 })
    .border({ width: 1, color: '#333333' })
  }

  @Builder
  TableRow(code: ChineseTelegraphCode, index: number) {
    Row() {
      Text(code.character)
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor(Color.White)
        .width('25%')
        .textAlign(TextAlign.Center)

      Text(code.code)
        .fontSize(16)
        .fontWeight(FontWeight.Normal)
        .fontColor('#CCCCCC')
        .width('75%')
        .textAlign(TextAlign.Center)
        .fontFamily('monospace')
    }
    .width('100%')
    .height(48)
    .backgroundColor(index % 2 === 0 ? '#0A0A0A' : '#111111')
    .padding({ left: 16, right: 16 })
    .border({ width: 1, color: '#333333' })
  }

  @Builder
  LoadingIndicator() {
    Column() {
      LoadingProgress()
        .width(40)
        .height(40)
        .color('#FFD700')
      
      Blank().height(16)
      
      Text('åŠ è½½ä¸­...')
        .fontSize(16)
        .fontColor('#CCCCCC')
        .textAlign(TextAlign.Center)
    }
    .width('100%')
    .height(200)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  build() {
    Column() {
      this.TitleBar()
      
      // å†…å®¹åŒºåŸŸ - å“åº”å¼å®½åº¦ï¼Œæœ€å¤§480vp
      Column() {
        // æœç´¢ä¸Žè¡¨å¤´å§‹ç»ˆå¯è§
        this.SearchBar()
        this.TableHeader()

        // åˆ—è¡¨æˆ–åŠ è½½ä¸­
        if (this.isLoading) {
          this.LoadingIndicator()
        } else {
          if (this.filteredCodes.length === 0) {
            // ç©ºæ•°æ®æç¤º
            Column() {
              Text('æš‚æ— æ•°æ®')
                .fontSize(14)
                .fontColor('#888888')
                .textAlign(TextAlign.Center)
            }
            .layoutWeight(1)
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .alignItems(HorizontalAlign.Center)
          } else {
            List() {
              ForEach(this.filteredCodes, (code: ChineseTelegraphCode, index: number) => {
                ListItem() {
                  this.TableRow(code, index)
                }
              }, (code: ChineseTelegraphCode) => code.character + code.code)
            }
            .layoutWeight(1)
            .divider({ strokeWidth: 0 })
            .scrollBar(BarState.Auto)
          }
        }
      }
      .width('100%')
      .constraintSize({ maxWidth: 480 })
      .padding({ left: 20, right: 20 })
      .layoutWeight(1)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
