import { LearnViewModel } from '../../viewmodel/LearnViewModel'
import { LessonItem } from '../../types/LessonTypes'
import { router } from '@kit.ArkUI'
import { eventHub, Events } from '../../utils/EventHub'
// System bar colors are set globally in EntryAbility

@Component
export struct LearnPage {
  private scroller: Scroller = new Scroller()
  @State vm: LearnViewModel = new LearnViewModel()
  @State private isInitialized: boolean = false
  @State private refreshTrigger: number = 0
  private lessonCompletedCallback: ((data: Object) => void) | null = null

  aboutToAppear(): void {
    // System bar colors are set globally in EntryAbility
    const uiContext2 = this.getUIContext()
    const hostContext2 = uiContext2.getHostContext()
    if (hostContext2) {
      // ç›´æŽ¥ç›‘å¬è¯¾ç¨‹å®Œæˆäº‹ä»¶ - ç¡®ä¿å®žæ—¶æ›´æ–°
      this.lessonCompletedCallback = (data: Object) => {
        console.error(`[LEARN] Direct lesson completed event received`)
        // åˆ·æ–° ViewModel æ•°æ®
        this.vm.refreshLessons()
        // è§¦å‘ UI æ›´æ–°
        this.refreshTrigger++
      }
      eventHub.on(Events.LESSON_COMPLETED, this.lessonCompletedCallback)
      
      this.vm.init(hostContext2).then(() => {
        this.isInitialized = true
      })
    }
  }

  onPageShow(): void {
    // ç®€åŒ–ï¼šåªåœ¨é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°çŠ¶æ€
    console.error(`[LEARN] onPageShow: triggered - refreshing state after lesson completion`)
    const uiContext = this.getUIContext()
    const hostContext = uiContext.getHostContext()
    if (hostContext) {
      this.vm.loadUnlockState(hostContext).then(() => {
        this.refreshTrigger++
      }).catch((error: Error) => {
        console.error('[LEARN] onPageShow: loadUnlockState failed:', error)
      })
    }
  }

  aboutToDisappear(): void {
    console.error('[LEARN] aboutToDisappear')
    // æ¸…ç†äº‹ä»¶ç›‘å¬
    if (this.lessonCompletedCallback) {
      eventHub.off(Events.LESSON_COMPLETED, this.lessonCompletedCallback)
      this.lessonCompletedCallback = null
    }
  }


  @Builder
  private LessonCard(item: LessonItem, unitLocked: boolean) {
    Stack({ alignContent: Alignment.Center }) {
      // å ä½è¯¾ç¨‹ä¸æ˜¾ç¤ºä»»ä½•å†…å®¹
      if (item.title !== 'å ä½') {
        // ä¸­é—´å†…å®¹ï¼šæ ‡é¢˜/å‰¯æ ‡é¢˜å§‹ç»ˆå±…ä¸­
        Column() {
          Text(item.title)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .textAlign(TextAlign.Center)
            .margin({ bottom: item.subtitle ? 8 : 0 })

          if (item.subtitle) {
            Text(item.subtitle)
              .fontSize(12)
              .fontColor('#B0B0B0')
              .textAlign(TextAlign.Center)
              .maxLines(2)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)

        // å³ä¾§æ‚¬æµ®å›¾æ ‡ï¼šâœ“ / ðŸ”’ / â€º - å¼•ç”¨refreshTriggerç¡®ä¿å“åº”å¼æ›´æ–°
        Row() {
          if (item.completed) {
            Text('âœ“').fontSize(20).fontColor(Color.Green)
          } else if (!item.unlocked) {
            Text('ðŸ”’').fontSize(16).fontColor('#B0B0B0')
          } else {
            Text('â€º').fontSize(16).fontColor(Color.White)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.End)
        .alignItems(VerticalAlign.Center)
        .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTriggerç¡®ä¿å“åº”å¼æ›´æ–°
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor(item.title === 'å ä½' ? Color.Transparent : '#1A1A1A')
    .border({ width: item.title === 'å ä½' ? 0 : 1, color: item.title === 'å ä½' ? Color.Transparent : '#333333' })
    .borderRadius(12)
    .opacity(item.unlocked ? 1.0 : 0.6)
    .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTriggerç¡®ä¿å“åº”å¼æ›´æ–°
    .onClick(() => {
      // Block navigation if locked or placeholder
      if (!item.unlocked || item.title === 'å ä½') { return }
      if (item.title !== 'å ä½') {
        console.error(`[LEARN] LessonCard click: key=${item.key} unlocked=${item.unlocked} unitLocked=${unitLocked}`)
        if (item.key === 'intro_1') {
          // Navigate to lesson page for the 2nd intro lesson (Chinese)
          console.error('[LEARN] Navigating to Chinese lesson page')
          router.push({
            url: 'pages/learn/KnowledgeLessonPage',
            params: {
              title: 'ä¸­æ–‡æ‘©å°”æ–¯ç”µç ',
              testTitle: 'ä¸­æ–‡ç”µç æµ‹è¯•',
              lessonCompletedKey: '2'
            }
          })
        } else if (item.key.startsWith('intro_')) {
          // Navigate to lesson page for the 1st intro lesson (Basics)
          console.error('[LEARN] Navigating to Intro lesson page')
          router.push({
            url: 'pages/learn/KnowledgeLessonPage',
            params: {
              title: 'æ‘©æ–¯å¯†ç åŸºç¡€è¯¾ç¨‹',
              testTitle: 'åŸºç¡€çŸ¥è¯†æµ‹è¯•',
              lessonCompletedKey: '1'
            }
          })
        } else if (item.key.startsWith('alpha_')) {
          // å­—æ¯è¯¾ç¨‹ - è·¯ç”±åˆ°LetterLessonPage
          const lessonIndex = parseInt(item.key.replace('alpha_', ''))
          const lessonNumber = 3 + lessonIndex // å­—æ¯è¯¾ç¨‹ä»Žç¬¬3è¯¾å¼€å§‹
          console.error(`[LEARN] Navigating to alphabet lesson: ${lessonNumber}`)
          router.push({
            url: 'pages/learn/LetterLessonPage',
            params: {
              lessonId: lessonNumber.toString(),
              title: item.title
            }
          })
        } else if (item.key.startsWith('number_')) {
          // æ•°å­—è¯¾ç¨‹ - è·¯ç”±åˆ°LetterLessonPage
          const lessonIndex = parseInt(item.key.replace('number_', ''))
          const lessonNumber = 12 + lessonIndex // æ•°å­—è¯¾ç¨‹ä»Žç¬¬12è¯¾å¼€å§‹
          console.error(`[LEARN] Navigating to number lesson: ${lessonNumber}`)
          router.push({
            url: 'pages/learn/LetterLessonPage',
            params: {
              lessonId: lessonNumber.toString(),
              title: item.title
            }
          })
        } else if (item.key.startsWith('punctuation_')) {
          // ç¬¦å·è¯¾ç¨‹ - è·¯ç”±åˆ°LetterLessonPage
          const lessonIndex = parseInt(item.key.replace('punctuation_', ''))
          const lessonNumber = 16 + lessonIndex // ç¬¦å·è¯¾ç¨‹ä»Žç¬¬16è¯¾å¼€å§‹
          console.error(`[LEARN] Navigating to punctuation lesson: ${lessonNumber}`)
          router.push({
            url: 'pages/learn/LetterLessonPage',
            params: {
              lessonId: lessonNumber.toString(),
              title: item.title
            }
          })
        } else if (item.key.startsWith('word_')) {
          // å•è¯è¯¾ç¨‹ - è·¯ç”±åˆ°LetterLessonPage
          const lessonIndex = parseInt(item.key.replace('word_', ''))
          const lessonNumber = 19 + lessonIndex // å•è¯è¯¾ç¨‹ä»Žç¬¬19è¯¾å¼€å§‹
          console.error(`[LEARN] Navigating to word lesson: ${lessonNumber}`)
          router.push({
            url: 'pages/learn/LetterLessonPage',
            params: {
              lessonId: lessonNumber.toString(),
              title: item.title
            }
          })
        } else {
          // For other lessons, show a placeholder message
          console.error(`[LEARN] Navigating to other lesson: ${item.key}`)
        }
      }
    })
  }

  @Builder
  private UnitCard(title: string, unitNumber: number, lessons: LessonItem[], isUnlocked: boolean) {
    RelativeContainer() {
      // Reference anchor filling the card (use empty Column due to Blank restriction)
      Column() {}
        .id('card')
        .width('100%')
        .height('100%')

      // Big faded number anchored to bottom-right of the card
      Text(`${unitNumber}`)
        .fontSize(80)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.White)
        .opacity(0.25)  // 25% opacity
        .alignRules({
          bottom: { anchor: 'card', align: VerticalAlign.Bottom },
          right:  { anchor: 'card', align: HorizontalAlign.End }
        })
        .margin({ right: 0, bottom: -10 })  // Negative bottom margin to move it closer
        .zIndex(0)

      Column()
        .alignRules({
          top:  { anchor: 'card', align: VerticalAlign.Top },
          left: { anchor: 'card', align: HorizontalAlign.Start }
        })
        .zIndex(1)
      {
        Row() {
          Text(title)
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .margin({ top: 24, bottom: 32 })

        // Lessons list (scroll within card); render placeholders with opacity 0 to keep vertical alignment
        Scroll() {
          Column() {
            ForEach(lessons, (l: LessonItem, idx: number) => {
              Column() {
                this.LessonCard(l, !isUnlocked) // Pass unit lock status
                if (idx < lessons.length - 1) { Blank().height(12) }
              }
              .opacity(l.title === 'å ä½' ? 0.0 : 1.0) // å ä½è¯¾ç¨‹ä¸å¯è§ä½†å æ®ç©ºé—´
              .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTriggerç¡®ä¿å“åº”å¼æ›´æ–°
            }, (l: LessonItem) => `${l.key}-${l.unlocked ? 'u' : 'l'}-${l.completed ? 'c' : 'n'}-${this.refreshTrigger}`) // åœ¨keyä¸­åŒ…å«refreshTrigger
          }
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)  // ç§»é™¤æ»šåŠ¨æ¡
        .edgeEffect(EdgeEffect.Spring)  // æ·»åŠ å¼¹æ€§æ•ˆæžœ
        .opacity(1.0)
        .enabled(true)  // æ‰€æœ‰å•å…ƒéƒ½å¯ç”¨æ»šåŠ¨
      }
    }
    .padding(16)
    .width('100%')
    .height('100%')
    .backgroundColor('#1A1A1A')
    .border({ width: 1, color: '#333333' })
    .borderRadius(12)
    .onClick(() => {
      // æ‰€æœ‰å•å…ƒéƒ½å·²è§£é”ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†
      console.info(`å•å…ƒ ${unitNumber} å·²è§£é”`)
    })
  }

  build() {
    Column() {
      if (this.isInitialized) {
        // Title bar - å¼•ç”¨refreshTriggerä½¿å…¶å“åº”å¼
        Row() {
          Text('å­¦ä¹ ')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .height(52)
        .padding({ left: 16, right: 16 })
        .backgroundColor(Color.Black)
        .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTrigger

        // Horizontal scroll of unit cards - è®©æ‰€æœ‰è¯¾ç¨‹å¡ç‰‡éƒ½å¼•ç”¨refreshTrigger
        Scroll(this.scroller) {
          Row() {
            // Intro unit (2 lessons + padding)
            Column() { 
              this.UnitCard('æ‘©æ–¯å¯†ç åŸºç¡€', 1, this.vm.introLessons, true) 
            }
            .width(320).height(500).margin({ right: 16 })
            .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTrigger

            // Alphabet unit (9)
            Column() { 
              this.UnitCard('å­—æ¯', 2, this.vm.alphabetLessons, true) 
            }
            .width(320).height(500).margin({ right: 16 })
            .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTrigger

            // Numbers unit (4)
            Column() { 
              this.UnitCard('æ•°å­—', 3, this.vm.numberLessons, true) 
            }
            .width(320).height(500).margin({ right: 16 })
            .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTrigger

            // Punctuation unit (3 + pad)
            Column() { 
              this.UnitCard('ç¬¦å·', 4, this.vm.punctuationLessons, true) 
            }
            .width(320).height(500).margin({ right: 16 })
            .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTrigger

            // Words unit (3 + pad)
            Column() { 
              this.UnitCard('å•è¯', 5, this.vm.wordLessons, true) 
            }
            .width(320).height(500)
            .opacity(this.refreshTrigger >= 0 ? 1 : 1) // å¼•ç”¨refreshTrigger
          }
        }
        .scrollable(ScrollDirection.Horizontal)
        .edgeEffect(EdgeEffect.Spring)
        .scrollBar(BarState.Off)
        .layoutWeight(1)
        .padding({ left: 16, right: 16, top: 16, bottom: 24 })
      } else {
        // Loading state
        Column() {
          Text('åŠ è½½ä¸­...')
            .fontSize(16)
            .fontColor(Color.White)
            .margin({ top: 200 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }
}
